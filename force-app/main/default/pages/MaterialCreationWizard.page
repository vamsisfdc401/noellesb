<!--*****************************************************************************************
Page Name: MaterialCreationWizard
Purpose: Create material from title,release or material level
******************************************************************************************
Version         DateModified         ModifiedBy               Change
1.0             03/09/2016           Suman/Mohit/Ipsita       Initial Development
2.0             11/09/2017           Jyothsna                 Changes made as part of REL-20
******************************************************************************************-->
<apex:page controller="MaterialCreationWizardController" docType="html-5.0" title="{!operatingObject} Wizard" sidebar="false">
    
    <style type="text/css">
        
        .bPageBlock .detailList tr td,
        .bPageBlock .detailList tr th,
        .hoverDetail .bPageBlock .detailList tr td,
        .hoverDetail .bPageBlock .detailList tr th {
        border-bottom: 0px solid #FFFFFF;
        }
        
        .custPopup {
            background-color: white;
            border-width: 2px;
            border-style: solid;
            z-index: 3;
            left: 50%;
            padding: 10px;
            position: fixed;
            width: 300px;
            margin-left: -200px;
            top: 200px;
        }
        
        .custMultiDiscPopup {
            // Added for RE-20
            //background-color: white;
            //border-width: 1px;
            //border-style: solid;
            z-index: 3;
            left: 50%;
            padding: 0px;
            position: fixed;
            width: 450px;
            margin-left: -220px;
            top: 200px;
        }
        
        .popupBackground {
        background-color: black;
        opacity: 0.20;
        filter: alpha(opacity=20);
        position: fixed;
        width: 100%;
        height: 100%;
        top: 0;
        left: 0;
        z-index: 2;
        }
        
        .nbcuButtonSet .nbcuButtonSetMenu a {
        white-space: nowrap;
        }
        
        /* Indentation of table. */
        .nbcu_rw_table_child {
        padding-left: 40px;
        }
        
        .nbcuButtonSetWrapper {
        display: inline-block;
        }
        
        .nbcuButtonSetLabel {
        cursor: pointer;
        padding: 3px 8px;
        background: #f8f8f8;
        border-radius: 5px;
        border: 1px solid gray;
        display: inline-block;
        color: black;
        font-weight: bold;
        }
        
        .nbcuButtonSetMenu {
        width: 150px;
        }
        
        .nbcuButtonSetMenu a {
        display: block;
        padding: 3px 8px;
        }
        
        .nbcu_exapnd_collapse {
        float: left;
        cursor: pointer;
        }
        
        .nbcu_table_rw {
        float: left;
        }
        
        .nbcu_rw_table_parent table,
        .nbcu_rw_table_child table {
        margin-bottom: 10px;
        }
        
        table.list {
        width: 900px !important;
        }
        
        .nbcu_commandlink {
        float: left;
        margin-left: 30px;
        width: 200px;
        }
        
        .nbcu_commandlink > a {
        display: inline-block;
        padding: 0 5px 5px 0;
        margin-right: 25px;
        }
        
        .nbcu_commandlink img {
        padding-right: 5px;
        }
        
        .nbcuButtonSet {
        position: relative;
        }
        
        .nbcuButtonSetMenu {
        display: none;
        position: absolute;
        top: 28px;
        right: 1px;
        background: #f8f8f8;
        padding: 5px;
        border-radius: 5px;
        border: 1px solid gray;
        z-index: 100;
        }
        
        .nbcu_wzd_fmt table select,
        .nbcu_wzd_fmt table input {
        width: 80px !important;
        }
        
        .nbcu_outer_shell{
        padding: 15px;
        border-bottom: 2px solid black;
        margin-top: 10px;
        }
        
        .nbcu_table_rw table {
        width: 923px !important;
        }
        
        .nbcu_table_rw td span,
        .nbcu_table_rw input,
        .nbcu_table_rw select,
        .nbcu_table_rw a,
        .nbcu_table_rw label {
        color: blue !important;
        }
        
        .clearfix:after {
        visibility: hidden;
        display: block;
        font-size: 0;
        content: " ";
        clear: both;
        height: 0;
        }
        * html .clearfix             { zoom: 1; } /* IE6 */
        *:first-child+html .clearfix { zoom: 1; } /* IE7 */
        
        /* New styles - Jordan's feedback. */
        /*.nbcu_table_existing_material tr td:nth-child(1) { width: 200px; }
        .nbcu_table_existing_material tr td:nth-child(2) { width: 60px; }
        .nbcu_table_existing_material tr td:nth-child(3) { width: 105px; }
        .nbcu_table_existing_material tr td:nth-child(4) { width: 50px; }
        .nbcu_table_existing_material tr td:nth-child(5) { width: 75px; }
        .nbcu_table_existing_material tr td:nth-child(6) { width: 30px; }
        
        .nbcu_table_existing_component tr td:nth-child(1) { width: 200px; }
        .nbcu_table_existing_component tr td:nth-child(2) { width: 55px; }
        .nbcu_table_existing_component tr td:nth-child(3) input { width: 50px; }
        .nbcu_table_existing_component tr td:nth-child(3) { width: 55px; }
        .nbcu_table_existing_component tr td:nth-child(4) { width: 15px; }
        .nbcu_table_existing_component tr td:nth-child(5) { width: 30px; }*/
        
        .col_width_30 {width:30px;}
        .col_width_50 {width:50px;}
        .col_width_80 {width:80px;}
        .col_width_100 {width:100px;}
        .col_width_200 {width:200px;}
        
    </style>
    
    <apex:includeScript value="{!URLFOR($Resource.NBCU_StyleClasses, '/js/vendor/jquery-1.11.2.min.js')}"/>
    <script>
    
    var listManagementPage;
    
    function openListManagementPage(territory, isExistingRecord, itemType, bomStatus, hasDChainFR)
    {              
        if((itemType != 'D (Display Vehicle)' && bomStatus != null && bomStatus != 'Draft') || 
           (itemType == 'D (Display Vehicle)' && isExistingRecord && (hasDChainFR == null || !hasDChainFR)))
        {
            if(itemType != 'D (Display Vehicle)')
                alert('Material/Component cannot be added due to BOM Status no longer being in Draft. Please reach out to Planning to make any further updates.');
            else
                alert('Display Vehicle should have D-Chain Spec \'FR\' to add child FERT material.');
        }
        else
        {
            listManagementPage = PopupCenter('/apex/WizardListManagementComponent?source=wizard&territory='+territory, 'Material Search', 900, 500);
            var winClosed = setInterval(function () {
                try{
                    if (listManagementPage.closed) {
                        //alert('Called from child');
                        clearInterval(winClosed);
                        selectedMat(); //Call your function here
                        //alert('Call Ended');
                    }
                }
                catch(e){alert(e);}
            }, 100);
        }
    }
    function openFERTListManagementPage(territory, isExistingRecord, itemType, bomStatus, hasDChainFR) 
    {
        if((itemType != 'D (Display Vehicle)' && bomStatus != null && bomStatus != 'Draft') || 
           (itemType == 'D (Display Vehicle)' && isExistingRecord && (hasDChainFR == null || !hasDChainFR)))
        {
            if(itemType != 'D (Display Vehicle)')
                alert('Material/Component cannot be added due to BOM Status no longer being in Draft. Please reach out to Planning to make any further updates.');
            else
                alert('Display Vehicle should have D-Chain Spec \'FR\' to add child FERT material.');
        }
        else
        {    
            if(territory =='US & CDN')/*USST-2878*/
            listManagementPage = PopupCenter('/apex/WizardListManagementComponent?source=wizard&matType=FERT&dualterritory=yes&territory='+territory, 'Material Search', 900, 500);
            else
            listManagementPage = PopupCenter('/apex/WizardListManagementComponent?source=wizard&matType=FERT&territory='+territory, 'Material Search', 900, 500);
            var winClosed = setInterval(function () {
                try{
                    if (listManagementPage.closed) {
                        //alert('Called from child');
                        clearInterval(winClosed);
                        selectedMat(); //Call your function here
                        //alert('Call Ended');
                    }
                }
                catch(e){alert(e);}
            }, 100);
        }
    }
    
    function PopupCenter(url, title, w, h) {
        // Fixes dual-screen position                         Most browsers      Firefox
        var dualScreenLeft = window.screenLeft != undefined ? window.screenLeft : screen.left;
        var dualScreenTop = window.screenTop != undefined ? window.screenTop : screen.top;
        
        var width = window.innerWidth ? window.innerWidth : document.documentElement.clientWidth ? document.documentElement.clientWidth : screen.width;
        var height = window.innerHeight ? window.innerHeight : document.documentElement.clientHeight ? document.documentElement.clientHeight : screen.height;
        
        var left = ((width / 2) - (w / 2)) + dualScreenLeft;
        var top = ((height / 2) - (h / 2)) + dualScreenTop;
        var newWindow = window.open(url, title, 'scrollbars=yes, width=' + w + ', height=' + h + ', top=' + top + ', left=' + left);
        
        // Puts focus on the newWindow
        if (window.focus) {
            newWindow.focus();
        }
        return newWindow;
    }
    
    function switchMenu(obj,obj1,obj2) 
    {
        var el = document.getElementById(obj);    
        
        
        if ( el.style.display != 'none' ) {
            el.style.display = 'none';
        }
        else {
            el.style.display = '';
        }
        
        var e2 = document.getElementById(obj1);                                       
        if ( e2.style.display != 'none' ) {
            e2.style.display = 'none';
        }
        else {
            e2.style.display = '';
        }
        
        var e3 = document.getElementById(obj2);                                       
        if ( e2.style.display != 'none' ) {
            e3.style.display = 'none';
        }
        else {
            e3.style.display = '';
        }        
    }
    
    function clickNbcuButtonSet() {
        $('.nbcuButtonSetLabel').on('click', function(e) {
            $(this).next('.nbcuButtonSetMenu').toggle();
            e.stopPropagation();
        });
        
        $(window).on('click', function() {
            $('.nbcuButtonSetMenu').hide();
        })
    }
    $(function() {
        clickNbcuButtonSet();
    })
    
    </script>
    
    
    <apex:sectionHeader title="{!operatingObject}" subtitle="Wizard" />
    <apex:pageMessages id="pgMsg"></apex:pageMessages>
    <!--Action status tag used to show ajax status-->
    <apex:actionStatus id="ajaxStatus">
        <apex:facet name="start">
            <div class="popupBackground" style="z-index:1001;" layout="block">&nbsp;</div>
            <div style="position:fixed;top:40%;left:50%;z-index:1002">
                <div style="padding:14px 10px;-webkit-border-radius: 5px;-moz-border-radius: 5px;border-radius: 5px;border:1px solid #1288FF;background-color:#F5F5F5;margin-left:-100px;vertical-align:top;">
                    <table>
                        <tr valign="bottom">
                            <td><img src="/img/loading.gif" width="25" height="25" /> &nbsp;</td>
                            <td><span style="font-weight:bold;font-color:#1288FF;font-size:14px;">Processing...</span></td>
                        </tr>
                    </table>
                </div>
            </div>
        </apex:facet>
    </apex:actionStatus>
    
    <apex:form >
        <!-- REL-18 Rerendering Pagemessages -->
        <apex:actionFunction name="selectedMat" action="{!getSelectedMat}" reRender="pgMsg, MasterContainerPanel" status="ajaxStatus" oncomplete="clickNbcuButtonSet();" />
        
        <apex:outputPanel id="MaterialTreePopUp">
            <apex:outputPanel styleClass="popupBackground" layout="block" rendered="{!showPopUp }" />
            <apex:outputPanel styleClass="custPopup" layout="block" rendered="{!showPopUp }">
                <apex:outputText ><b>Enter the quantity: </b></apex:outputTExt>
                <apex:input value="{!qtyCount}" type="number" html-min="0" /><br/>
                
                <div align="center">
                    <apex:commandButton value="OK" rerender="MaterialTreePopUp, MasterContainer" action="{!copyMaterialTree}" status="ajaxStatus"
                                        oncomplete="clickNbcuButtonSet();"/>
                    <apex:commandButton value="Cancel" rerender="MaterialTreePopUp" action="{!closePopUp}" status="ajaxStatus" oncomplete="clickNbcuButtonSet();"/>
                </div>
            </apex:outputPanel>
        </apex:outputPanel>
        
        <!-- Added for RE-20 -->
        <apex:outputPanel id="MultiDiscPopUp">
            <apex:outputPanel styleClass="popupBackground" layout="block" rendered="{!showMultiDiscPopUp}" />
            <apex:outputPanel styleClass="custMultiDiscPopup" layout="block" rendered="{!showMultiDiscPopUp}">
                <apex:pageMessages id="pgMsg2"></apex:pageMessages>
                <apex:pageBlock mode="Edit" title="Add Multiple Discs">
                    <apex:pageBlockButtons location="bottom">
                        <apex:commandButton value="OK" rerender="pgMsg2, MultiDiscPopUp, MasterContainer" action="{!createMultipleDisc}" status="ajaxStatus"
                                        oncomplete="clickNbcuButtonSet();"/>
                        <apex:commandButton value="Cancel" rerender="MultiDiscPopUp, MasterContainer" action="{!closePopUp}" status="ajaxStatus" oncomplete="clickNbcuButtonSet();"/>
                    </apex:pageBlockButtons>
                    <apex:pageBlockSection collapsible="false" columns="1">
                        <apex:pageBlockSectionItem >
                            <apex:outputLabel >Component Type</apex:outputLabel>
                            <apex:selectList value="{!selectedDiscType}" size="1">
                                <apex:selectOptions value="{!discTypes}"></apex:selectOptions>
                            </apex:selectList>
                        </apex:pageBlockSectionItem>
                        <apex:pageBlockSectionItem >
                            <apex:outputText >Enter the quantity:</apex:outputTExt>
                            <apex:input value="{!multiDiscQty}" type="number" html-min="0" style="text-align:right;" />
                        </apex:pageBlockSectionItem>
                    </apex:pageBlockSection>
                </apex:pageBlock>
            </apex:outputPanel>
        </apex:outputPanel>
        
        <apex:outputPanel id="MasterContainerPanel">
            <apex:pageBlock id="MasterContainer" mode="mainDetail">
                <apex:pageBlockButtons location="bottom">
                    <apex:commandButton value="Next >" action="{!setMaterialDetails}" rendered="{!AND(NOT(showMaterialDesc), NOT(hasError2))}"
                                        />
                    <apex:commandButton value="Cancel" action="{!cancel}" immediate="true" html-formnovalidate="formnovalidate" />
                </apex:pageBlockButtons>
                
                <!--page block section for creating new release-->
                <apex:pageBlockSection id="pgSectionNewRelease" title="Provide Release Information" collapsible="false" rendered="{!showReleaseNew}">
                    <apex:pageblocksectionItem >
                        <apex:outputLabel >Release Name</apex:outputLabel>
                        <!--<apex:actionRegion >-->
                        <apex:inputField value="{!releaseDetails.Name}" required="true">
                            <apex:actionSupport event="onchange" reRender="MasterContainerPanel" action="{!setReleaseName}" status="ajaxStatus" oncomplete="clickNbcuButtonSet();" />
                        </apex:inputField>
                        <!--</apex:actionRegion>-->
                    </apex:pageblocksectionItem>
                    
                    <apex:pageblocksectionItem rendered="{!showTitleInputField}">
                        <apex:outputLabel >Title</apex:outputLabel>
                        <!--<apex:actionRegion >-->
                        <apex:inputField value="{!releaseDetails.Title__c}">
                            <apex:actionSupport event="onchange" reRender="MasterContainerPanel" action="{!setStreetDateOnTitleChange}" status="ajaxStatus" oncomplete="clickNbcuButtonSet();">
                            </apex:actionSupport>
                        </apex:inputField>
                        <!--</apex:actionRegion>-->
                    </apex:pageblocksectionItem>
                    
                    <apex:outputField value="{!releaseDetails.Title__c}" rendered="{!showTitleOutputField }" />
                    
                    <apex:pageblocksectionItem >
                        <apex:outputLabel >Street Date</apex:outputLabel>
                        <!--<apex:actionRegion >-->
                        <apex:inputField value="{!releaseDetails.Street_Date__c}">
                            <apex:actionSupport event="onchange" reRender="MasterContainerPanel" status="ajaxStatus" oncomplete="clickNbcuButtonSet();"/>
                        </apex:inputField>
                        <!--</apex:actionRegion>-->
                    </apex:pageblocksectionItem>
                    
                    <apex:pageblocksectionItem >
                        <apex:outputLabel >Brand Group</apex:outputLabel>
                        <!-- Changed for REL-45 -->
                        <apex:inputField value="{!releaseDetails.Brand_Group__c}">
                            <apex:actionSupport event="onchange" action="{!addWarningMsgOnBrandGroupChange}" reRender="MasterContainerPanel,pgMsg" status="ajaxStatus" oncomplete="clickNbcuButtonSet();"/>
                        </apex:inputField>
                    </apex:pageblocksectionItem>
                    
                    <apex:pageblocksectionItem >
                        <apex:outputLabel >Territory</apex:outputLabel>
                        <!--<apex:actionRegion >-->
                        <apex:inputField value="{!releaseDetails.Territory__c}">
                            <apex:actionSupport event="onchange" action="{!setTerritoryDetails}" reRender="MasterContainerPanel,pgMsg" status="ajaxStatus" oncomplete="clickNbcuButtonSet();"
                                                />
                        </apex:inputfield>
                        <!--</apex:actionRegion>-->
                    </apex:pageblocksectionItem>
                    
                    <apex:pageblocksectionItem >
                        <apex:outputLabel >Project Type</apex:outputLabel>
                        <!-- Changed for REL-45 -->
                        <apex:inputField value="{!releaseDetails.Project_Type__c}">
                            <apex:actionSupport event="onchange" reRender="MasterContainerPanel" status="ajaxStatus" oncomplete="clickNbcuButtonSet();"/>
                        </apex:inputField>
                    </apex:pageblocksectionItem>
                    
                    <apex:pageblocksectionItem >
                        <apex:outputLabel >Promotion Name Abbreviation</apex:outputLabel>
                        <!--<apex:actionRegion >-->
                        <apex:inputField value="{!releaseDetails.Promotion_Name_Abbreviation__c}">
                            <apex:actionSupport event="onchange" reRender="" oncomplete="clickNbcuButtonSet();"/>
                        </apex:inputField>
                        <!--</apex:actionRegion>-->
                    </apex:pageblocksectionItem>
                    
                    <apex:pageblocksectionItem >
                        <apex:outputLabel >Label Code</apex:outputLabel>
                        <!--<apex:actionRegion >-->
                        <apex:inputField value="{!releaseDetails.Label_Code__c}">
                            <apex:actionSupport event="onchange" reRender="MasterContainerPanel" status="ajaxStatus" oncomplete="clickNbcuButtonSet();"/>
                        </apex:inputField>
                        <!--</apex:actionRegion>-->
                    </apex:pageblocksectionItem>
                    
                    <apex:pageblocksectionItem rendered="{!releaseDetails.Project_Type__c == 'Catalog'}">
                        <apex:outputLabel >Promotion Type</apex:outputLabel>
                        <!--<apex:actionRegion >-->
                        <apex:inputField value="{!releaseDetails.Promotion_Type__c}">
                            <apex:actionSupport event="onchange" reRender="" oncomplete="clickNbcuButtonSet();"/>
                        </apex:inputField>
                        <!--</apex:actionRegion>-->
                    </apex:pageblocksectionItem>
                    
                    <apex:pageBlockSectionItem rendered="{!releaseDetails.Project_Type__c == 'Catalog'}">
                        
                    </apex:pageBlockSectionItem>
                    
                    <!-- Added for REL-45 -->
                    <apex:pageblocksectionItem >
                        <apex:outputLabel >Choose Template</apex:outputLabel>
                        <apex:selectList value="{!selectedTemplateId}" size="1" disabled="{!availableTemplates.size == 0}">
                            <apex:selectOptions value="{!availableTemplates}"></apex:selectOptions>
                            <apex:actionSupport event="onchange" action="{!setTemplateMaterials}" reRender="MasterContainerPanel, pgMsg" status="ajaxStatus" oncomplete="clickNbcuButtonSet();"/>
                        </apex:selectList>
                    </apex:pageblocksectionItem>
                    
                </apex:pageBlockSection>
                <!--End of page block section for new release creation-->
                
                <!--page block section to display release details for update scenario-->
                <apex:pageBlockSection id="pgSectionExistingRelease" title="Release Information" collapsible="false" rendered="{!showReleaseView}">
                    <apex:outputField value="{!releaseDetails.Name}" />
                    <apex:outputField value="{!releaseDetails.Title__c}" />
                    <apex:outputField value="{!releaseDetails.Street_Date__c}" />
                    <apex:outputField value="{!releaseDetails.Brand_Group__c}" />
                    <apex:outputField value="{!releaseDetails.Territory__c}" />
                    <apex:outputField value="{!releaseDetails.Project_Type__c}" />
                    <apex:outputField value="{!releaseDetails.Promotion_Name_Abbreviation__c}" />
                    <apex:outputField value="{!releaseDetails.Label_Code__c}" />
                    <!-- Added for REL-45 -->
                    <apex:pageblocksectionItem >
                        <apex:outputLabel >Choose Template</apex:outputLabel>
                        <apex:selectList value="{!selectedTemplateId}" size="1" disabled="{!availableTemplates.size == 0}">
                            <apex:selectOptions value="{!availableTemplates}"></apex:selectOptions>
                            <apex:actionSupport event="onchange" action="{!setTemplateMaterials}" reRender="MasterContainerPanel, pgMsg" status="ajaxStatus" oncomplete="clickNbcuButtonSet();"/>
                        </apex:selectList>
                    </apex:pageblocksectionItem>
                </apex:pageBlockSection>
                <!--End of page block section-->
                
                <apex:pageBlockSection id="pgSectionExistingMaterial" title="Material Information" collapsible="false" rendered="{!showMaterialView}">
                    <apex:outputField value="{!materialDetails.Name}" />
                    <apex:outputField value="{!materialDetails.Release__c}" />
                    <apex:outputField value="{!materialDetails.Item_Type__c}" />
                    <apex:outputField value="{!materialDetails.Item_Code__c}" />
                    <apex:outputField value="{!materialDetails.Material_Type__c}" />
                </apex:pageBlockSection>
                <!--End of page block section-->
                
                <div style="width:99%;padding-top:10px;">
                    <div style="float:left;">
                        <div style="width:20px;height:20px;-webkit-border-radius: 10px;-moz-border-radius: 10px;border-radius: 10px;background-color:#E38D84;float:left;">&nbsp;</div><div style="float:left;padding: 5px;font-weight:bold;">First level</div>
                        <div style="width:20px;height:20px;-webkit-border-radius: 10px;-moz-border-radius: 10px;border-radius: 10px;background-color:#9BB063;float:left;">&nbsp;</div><div style="float:left;padding: 5px;font-weight:bold;">Second level</div>
                        <div style="width:20px;height:20px;-webkit-border-radius: 10px;-moz-border-radius: 10px;border-radius: 10px;background-color:#7581BA;float:left;">&nbsp;</div><div style="float:left;padding: 5px;font-weight:bold;">Third level</div>
                        <div style="width:20px;height:20px;-webkit-border-radius: 10px;-moz-border-radius: 10px;border-radius: 10px;background-color:#E09100;float:left;">&nbsp;</div><div style="float:left;padding: 5px;font-weight:bold;">Fourth level</div>
                    </div>
                    <div style="float:right;padding-top:5px;">
                        <apex:commandLink action="{!addFormats}" reRender="MasterContainer" status="ajaxStatus" oncomplete="window.scrollTo(0,document.body.scrollHeight);clickNbcuButtonSet();"
                                          rendered="{!AND(NOT(hasError2), $CurrentPage.parameters.source!='materialdetail', $CurrentPage.parameters.source!='materiallistview')}">
                            <span style="padding-right:8px;"><apex:image id="mainImgAdd" value="{!$Resource.Add}" width="12" title="Add Parent Material"/></span>
                            <apex:outputText ><b>New Material</b></apex:outputText>
                        </apex:commandLink>
                        
                        <apex:commandLink reRender="MasterContainer" status="ajaxStatus" onClick="openFERTListManagementPage('{!releaseDetails.Territory__c}', false, '', 'Draft', false);"
                                          rendered="{!AND(NOT(hasError2), $CurrentPage.parameters.source!='materialdetail', $CurrentPage.parameters.source!='materiallistview')}">
                            <span style="padding-left:5px;padding-right:4px;"><apex:image id="AddImg3" value="{!$Resource.Add}" width="12"/></span>
                            <apex:outputText ><b>Existing Material</b></apex:outputText>
                            <apex:param value="0" name="openFERTListManagementPage111" assignTo="{!materialIndex}" />
                            <apex:param value="1" name="bomDepth11" assignTo="{!selectedMaterialLevel}" />
                            <apex:param value="FERT" name="materialType11" assignTo="{!materialType}" />
                            <apex:param value="TRUE" name="addToTop " assignTo="{!addToTop}" />
                        </apex:commandLink>
                    </div>
                </div>
                
                <br clear="all"/>
                
                <hr style="border-bottom: 2px solid black;"/>
                
                <apex:outputPanel id="panel1stLevel">
                    <!-- BOM Hierarchy Configuration -->
                    <apex:variable var="l1Index" value="{!0}" />
                    <apex:repeat value="{!rootIns.Data}" var="material" id="repeatLevel1">
                        <!-- Level 1: FERTs -->
                        <apex:variable var="materialIndexPath1" value="{!TEXT(l1Index)}" />
                        <apex:outputPanel styleClass="nbcu_outer_shell clearfix" layout="block">
                            <!--nesting entire section-->
                            <apex:outputPanel layout="block" styleClass="nbcu_rw_table_parent clearfix">
                                <!--Entire button enclosed for level 1-->
                                <!-- FERT Details -->
                                <apex:outputPanel layout="block" styleclass="nbcu_tableset">
                                    <!--outputpanel for existing and new materials-->
                                    <apex:outputpanel id="plusimage1" style="display:{!if(material.isCollapsed,"block","none")};" styleclass="nbcu_exapnd_collapse">
                                        <apex:image url="{!$Resource.Chevron_Right_Pink}">
                                            <apex:actionSupport event="onclick" reRender="MasterContainer" action="{!sectionCollapseExpand}" status="ajaxStatus" oncomplete="clickNbcuButtonSet();">
                                                <apex:param value="{!materialIndexPath1}" name="materialIndex1" assignTo="{!materialIndex}" />
                                                <apex:param value="{!1}" name="bomDepth1" assignTo="{!selectedMaterialLevel}" />
                                            </apex:actionSupport>                                   
                                        </apex:image>
                                    </apex:outputpanel>
                                    <apex:outputpanel id="minusimage1" style="display:{!if(material.isCollapsed,"none","block")};" styleclass="nbcu_exapnd_collapse">
                                        <apex:image url="{!$Resource.Chevron_Down_Pink}" >
                                            <apex:actionSupport event="onclick" reRender="MasterContainer" action="{!sectionCollapseExpand}" status="ajaxStatus" oncomplete="clickNbcuButtonSet();">
                                                <apex:param value="{!materialIndexPath1}" name="materialIndex1" assignTo="{!materialIndex}" />
                                                <apex:param value="{!1}" name="bomDepth1" assignTo="{!selectedMaterialLevel}" />
                                            </apex:actionSupport>
                                            
                                        </apex:image>
                                    </apex:outputpanel>
                                    
                                    <!-- Existing Material -->
                                    <apex:outputPanel layout="block" styleClass="nbcu_table_rw nbcu_table_existing_material">
                                        <apex:pageBlockTable value="{!material}" var="mat" rendered="{!material.isExistingRecord}">
                                            <apex:column headerValue="Material Description" styleClass="col_width_200">
                                                <apex:outputField value="{!mat.instance.Name}" />
                                            </apex:column>
                                            <apex:column headerValue="Material Number" styleClass="col_width_100">
                                                <apex:outputField value="{!mat.instance.Material_Number__c}" />
                                            </apex:column>
                                            <apex:column headerValue="Title/SGENNO" styleClass="col_width_100">
                                                <apex:outputField value="{!mat.instance.Title__c}" /> &nbsp;
                                                <!--<apex:outputLabel style="font-size: 13px;" value="{!mat.sysgenNo}"></apex:outputlabel>-->
                                            </apex:column>
                                            <apex:column headerValue="Label Code" styleClass="col_width_100">
                                                <apex:outputField value="{!mat.instance.Label_Code__c}" />
                                            </apex:column>
                                           
                                            <apex:column headerValue="Territory" styleClass="col_width_30">
                                                <apex:outputField value="{!mat.instance.Territory__c}" />
                                            </apex:column>
                                            <apex:column headerValue="Sub-Format" styleClass="col_width_100" rendered="{!showMPM}">                                             
                                                <apex:outputField value="{!mat.instance.Subformat__c}" />
                                            </apex:column>
                                        </apex:pageBlockTable>
                                    </apex:outputPanel>
                                    <!-- Existing Material -->
                                    
                                    <!-- New Material -->
                                    <apex:outputPanel layout="block" styleClass="nbcu_table_rw nbcu_wzd_fmt">
                                        <apex:pageBlockTable value="{!material}" var="mat" rendered="{!NOT(material.isExistingRecord)}">
                                            <apex:column headerValue="Wizard Format">
                                                <apex:inputField value="{!mat.instance.Format_Description__c}" style="width:auto;">
                                                    <apex:actionSupport event="onchange" reRender="MasterContainer" action="{!setTitleDetailsG1200}" status="ajaxStatus" oncomplete="clickNbcuButtonSet();">
                                                        <apex:param value="{!materialIndexPath1}" name="materialIndex1" assignTo="{!materialIndex}" />
                                                        <apex:param value="{!1}" name="bomDepth1" assignTo="{!selectedMaterialLevel}" />
                                                    </apex:actionSupport>
                                                </apex:inputfield>
                                            </apex:column>
                                            <apex:column headerValue="Material Type">
                                                <apex:inputField value="{!mat.instance.Material_Type__c}" style="width:auto;">
                                                    <apex:actionSupport event="onchange" reRender="MasterContainer" status="ajaxStatus" oncomplete="clickNbcuButtonSet();"/>
                                                </apex:inputField>
                                            </apex:column>
                                            <apex:column headerValue="Item Type">
                                                <apex:inputField value="{!mat.instance.Item_Type__c}" style="width:auto;">
                                                    <apex:actionSupport event="onchange" reRender="MasterContainer" action="{!setTitleDetailsG1200}" status="ajaxStatus" oncomplete="clickNbcuButtonSet();">
                                                        <apex:param value="{!materialIndexPath1}" name="materialIndex1" assignTo="{!materialIndex}" />
                                                        <apex:param value="{!1}" name="bomDepth1" assignTo="{!selectedMaterialLevel}" />
                                                    </apex:actionSupport>
                                                </apex:inputField>
                                            </apex:column>
                                            <apex:column headerValue="Item Code">
                                                <!--<apex:inputField value="{!mat.instance.Item_Code__c}" style="width:auto;" />-->
                                                <apex:inputField value="{!mat.instance.Item_Code__c}" style="width:auto;">
                                                    <apex:actionSupport event="onchange" reRender="MasterContainer" action="{!setTitleDetailsG1200}" status="ajaxStatus" oncomplete="clickNbcuButtonSet();">
                                                        <apex:param value="{!materialIndexPath1}" name="materialIndex1" assignTo="{!materialIndex}" />
                                                        <apex:param value="{!1}" name="bomDepth1" assignTo="{!selectedMaterialLevel}" />
                                                    </apex:actionSupport>
                                                </apex:inputField>
                                            </apex:column>
                                            <apex:column headerValue="Title/SGENNO">
                                                <apex:inputfield value="{!mat.instance.Title__c}" style="width:auto;">
                                                    <apex:actionSupport event="onchange" reRender="MasterContainer" action="{!setTitleDetails}" status="ajaxStatus" oncomplete="clickNbcuButtonSet();">
                                                        <apex:param value="{!materialIndexPath1}" name="materialIndex1" assignTo="{!materialIndex}" />
                                                        <apex:param value="{!1}" name="bomDepth1" assignTo="{!selectedMaterialLevel}" />
                                                    </apex:actionSupport>
                                                </apex:inputField>
                                                <!--<apex:outputLabel value="{!mat.sysgenNo}" />-->
                                            </apex:column>
                                            <apex:column headerValue="Retailer/Rental">
                                                <apex:inputField value="{!mat.instance.Retailer_Rental__c}" style="width:auto;" />
                                            </apex:column>
                                            
                                            <apex:column headerValue="Territory">
                                                <apex:inputField value="{!mat.instance.Territory__c}" style="width:auto;">
                                                    <apex:actionSupport event="onchange" reRender="MasterContainer" status="ajaxStatus" oncomplete="clickNbcuButtonSet();"/>
                                                </apex:inputField><!--USST-2828 and USST-3161-->
                                            </apex:column>
                                            
                                            <apex:column headerValue="Sub-Format" rendered="{!showMPM}"> 
                                                <apex:inputField value="{!mat.instance.Subformat__c}">
                                                </apex:inputField>
                                            </apex:column>
                                        </apex:pageBlockTable>
                                    </apex:outputPanel>
                                    
                                    
                                </apex:outputPanel>
                                
                                <!--outputpanel for buttons level 1-->
                                <apex:outputPanel layout="block" styleclass="nbcu_commandlink">
                                    <div class="nbcuButtonSetLabel" style="padding-top:7px;display:{!if(material.instance.Item_Code__c != 'BF - BABY FERT',"inline","none")};">
                                        <apex:commandLink action="{!addComponent}" rerender="MasterContainer, pgMsg" status="ajaxStatus" rendered="{!material.instance.Item_Code__c != 'BF - BABY FERT'}" oncomplete="clickNbcuButtonSet();">
                                            <span><apex:image id="AddImage" value="{!$Resource.Add}" width="12" /></span>
                                            <apex:outputText ><b>C</b></apex:outputText>
                                            <apex:param value="{!materialIndexPath1}" name="addComponent1" assignTo="{!materialIndex}" />
                                            <apex:param value="{!1}" name="bomDepth1" assignTo="{!selectedMaterialLevel}" />
                                        </apex:commandLink>
                                    </div> &nbsp;
                                    <apex:outputPanel layout="block" styleclass="nbcuButtonSetWrapper" rendered="{!NOT(AND(operatingObject=='Material', material.instance.Item_Code__c=='BF - BABY FERT'))}">
                                        <div class="nbcuButtonSet">
                                            <apex:outputPanel layout="none">
                                                <label class="nbcuButtonSetLabel"><apex:image url="{!$Resource.Chevron_Down_Btn}" height="16" width="17" /></label>
                                                <div class="nbcuButtonSetMenu">
                                                    <apex:outputPanel layout="none">
                                                        <apex:commandLink action="{!addMaterial}" reRender="MasterContainer, pgMsg" status="ajaxStatus" rendered="{!material.instance.Item_Type__c != 'S (Single)'}" oncomplete="clickNbcuButtonSet();">
                                                            <span><apex:image id="AddImg" value="{!$Resource.Add}" width="12"/></span>
                                                            <apex:outputText ><b>New Material</b></apex:outputText>
                                                            <apex:param value="{!materialIndexPath1}" name="addMaterial1" assignTo="{!materialIndex}" />
                                                            <apex:param value="{!1}" name="bomDepth1" assignTo="{!selectedMaterialLevel}" />
                                                        </apex:commandLink>
                                                        
                                                        <apex:commandLink reRender="MasterContainer, pgMsg" rendered="{!material.instance.Item_Code__c != 'BF - BABY FERT'}" status="ajaxStatus" onClick="openListManagementPage('{!material.instance.Territory__c}', {!material.isExistingRecord}, '{!material.instance.Item_Type__c}', '{!material.instance.BOM_Status__c}', {!material.hasDChainFR});" oncomplete="clickNbcuButtonSet();">
                                                            <span><apex:image id="AddImg2" value="{!$Resource.Add}" width="12"/></span>
                                                            <apex:outputText ><b>Existing Component</b></apex:outputText>
                                                            <apex:param value="{!materialIndexPath1}" name="openListManagementPage1" assignTo="{!materialIndex}" />
                                                            <apex:param value="{!1}" name="bomDepth1" assignTo="{!selectedMaterialLevel}" />
                                                            <apex:param value="COMPONENT" name="materialType1" assignTo="{!materialType}" />
                                                        </apex:commandLink>
                                                        
                                                        <apex:commandLink reRender="MasterContainer, pgMsg" status="ajaxStatus" onClick="openFERTListManagementPage('{!material.instance.Territory__c}', {!material.isExistingRecord}, '{!material.instance.Item_Type__c}', '{!material.instance.BOM_Status__c}', {!material.hasDChainFR});"
                                                                          rendered="{!material.instance.Item_Type__c != 'S (Single)'}" oncomplete="clickNbcuButtonSet();">
                                                            <span><apex:image id="AddImg3" value="{!$Resource.Add}" width="12"/></span>
                                                            <apex:outputText ><b>Existing Material</b></apex:outputText>
                                                            <apex:param value="{!materialIndexPath1}" name="openFERTListManagementPage1" assignTo="{!materialIndex}" />
                                                            <apex:param value="{!1}" name="bomDepth1" assignTo="{!selectedMaterialLevel}" />
                                                            <apex:param value="FERT" name="materialType1" assignTo="{!materialType}" />
                                                        </apex:commandLink>
                                                        
                                                        <!-- Added for RE-20 -->
                                                        <apex:commandLink action="{!openMultiDiscPopUp}" reRender="MultiDiscPopUp" status="ajaxStatus" rendered="{!material.instance.Item_Code__c != 'BF - BABY FERT'}" oncomplete="clickNbcuButtonSet();">
                                                            <span><apex:image id="AddImg4" value="{!$Resource.Add}" width="14"/></span>
                                                            <apex:outputText ><b>Add Multiple Discs</b></apex:outputText>
                                                            <apex:param value="{!materialIndexPath1}" name="openPopUp1" assignTo="{!materialIndex}" />
                                                            <apex:param value="{!1}" name="bomDepth1" assignTo="{!selectedMaterialLevel}" />
                                                        </apex:commandLink>
                                                        
                                                        <apex:commandLink action="{!openPopUp}" reRender="MaterialTreePopUp" status="ajaxStatus" rendered="{!AND((sourceType!='materiallistview'),(sourceType!='materialdetail'))}" oncomplete="clickNbcuButtonSet();">
                                                            <span><apex:image id="AddImg1" value="{!$Resource.CheckImg}" width="14"/></span>
                                                            <apex:outputText ><b>Copy Material Tree</b></apex:outputText>
                                                            <apex:param value="{!materialIndexPath1}" name="openPopUp1" assignTo="{!materialIndex}" />
                                                            <apex:param value="{!1}" name="bomDepth1" assignTo="{!selectedMaterialLevel}" />
                                                        </apex:commandLink>
                                                        <apex:commandLink action="{!removeFERTs}" reRender="MasterContainer, pgMsg" status="ajaxStatus" rendered="{!AND((sourceType!='materiallistview'),(sourceType!='materialdetail'))}" oncomplete="clickNbcuButtonSet();">
                                                            <span><apex:image id="RemoveImage" value="{!$Resource.Remove}" width="12" title="Remove"/></span>
                                                            <apex:outputText ><b>Remove</b></apex:outputText>
                                                            <apex:param value="{!materialIndexPath1}" name="removeFERTs1" assignTo="{!materialIndex}" />
                                                            <apex:param value="{!1}" name="bomDepth1" assignTo="{!selectedMaterialLevel}" />
                                                        </apex:commandLink>
                                                    </apex:outputPanel>
                                                </div>
                                            </apex:outputPanel>
                                        </div>
                                    </apex:outputPanel>
                                    
                                </apex:outputPanel>
                                <!--outputpanel for buttons level 1-->
                            </apex:outputPanel>
                            
                            
                            <!-- Level 1: Components -->
                            <apex:outputPanel id="inlinetablesec" rendered="{!NOT(material.isCollapsed)}"  layout="block" styleClass="nbcu_rw_table_child">
                                <!--outputpanel for all level 1 childs-->
                                <!-- Existing Components -->
                                <apex:outputpanel layout="block" rendered="{!material.existingComponents.size > 0}">
                                    <apex:outputPanel layout="block" styleclass="nbcu_rw_table nbcu_table_existing_component">
                                        <apex:variable value="{!0}" var="componentIndex1" />
                                        <apex:pageBlockTable value="{!material.existingComponents}" var="comp">
                                            <apex:column headerValue="Material Description" styleClass="col_width_200">
                                                <apex:outputField value="{!comp.instance.Name}" />
                                                <apex:commandLink action="{!removeComponent}" rerender="MasterContainer, pgMsg" status="ajaxStatus" oncomplete="clickNbcuButtonSet();">
                                                    <span style="padding-left:10px;"><apex:image id="RemoveImage" value="{!$Resource.Remove}" width="10" title="Remove"/></span>
                                                    <apex:param value="{!comp.localComponentId}" name="componentIndex1" assignTo="{!componentIndex}" />
                                                    <apex:param value="{!materialIndexPath1}" name="removeComponent1" assignTo="{!materialIndex}" />
                                                    <apex:param value="{!1}" name="selectedMaterialLevel1" assignTo="{!selectedMaterialLevel}" />
                                                </apex:commandLink>
                                                <apex:variable var="componentIndex1" value="{!componentIndex1+ 1}" />
                                            </apex:column>
                                            
                                            <apex:column headerValue="Component Number" styleClass="col_width_100">
                                                <apex:outputField value="{!comp.instance.Material_Number__c}" />
                                            </apex:column>
                                            
                                            <apex:column headerValue="Item Qty" styleClass="col_width_50 ">
                                                <apex:inputText value="{!comp.ComponentQty}" styleClass="col_width_50"/>
                                            </apex:column>
                                            
                                            <apex:column headerValue="Label Code" styleClass="col_width_100">
                                                <apex:outputField value="{!comp.instance.Label_Code__c}" />
                                            </apex:column>
                                            <apex:column headerValue="Territory" styleClass="col_width_30">
                                                <apex:outputField value="{!comp.instance.Territory__c}" />
                                            </apex:column>
                                            <!--<apex:column headerValue="Sub-Format" styleClass="col_width_100" rendered="{!showMPM}">                                            
<apex:outputField value="{!comp.instance.Subformat__c}" />
</apex:column>-->
                                            
                                        </apex:pageBlockTable>
                                    </apex:outputPanel>
                                </apex:outputPanel>
                                
                                <!-- New Components -->
                                <apex:outputPanel layout="block" rendered="{!material.newComponents.size > 0}">
                                    <apex:outputPanel layout="block" styleclass="nbcu_rw_table">
                                        <apex:variable value="{!0}" var="componentIndex1" />
                                        <apex:pageBlockTable value="{!material.newComponents}" var="comp">
                                            <apex:column headerValue="Component Type">
                                                <apex:inputField value="{!comp.instance.Component_Type__c}">
                                                    <!-- added action support as part of REL-20 changes -->
                                                    <apex:actionSupport event="onchange" reRender="MasterContainer" action="{!updateTerritoryOfDisc}" status="ajaxStatus" oncomplete="clickNbcuButtonSet();">
                                                        <apex:param value="{!comp.localComponentId}" name="componentIndex1" assignTo="{!componentIndex}" />
                                                        <!-- componentIndex1 -->
                                                        <apex:param value="{!materialIndexPath1}" name="Component1" assignTo="{!materialIndex}" />
                                                        <apex:param value="{!1}" name="selectedMaterialLevel1" assignTo="{!selectedMaterialLevel}" />
                                                    </apex:actionSupport>
                                               </apex:inputfield>
                                                <apex:commandLink action="{!removeComponent}" rerender="MasterContainer, pgMsg" status="ajaxStatus" oncomplete="clickNbcuButtonSet();">
                                                    <span style="padding-left:10px;"><apex:image id="RemoveImage" value="{!$Resource.Remove}" width="10" title="Remove"/></span>
                                                    <apex:param value="{!comp.localComponentId}" name="componentIndex1" assignTo="{!componentIndex}" />
                                                    <!-- componentIndex1 -->
                                                    <apex:param value="{!materialIndexPath1}" name="removeComponent1" assignTo="{!materialIndex}" />
                                                    <apex:param value="{!1}" name="selectedMaterialLevel1" assignTo="{!selectedMaterialLevel}" />
                                                </apex:commandLink>
                                                <apex:variable var="componentIndex1" value="{!componentIndex1+ 1}" />
                                            </apex:column>
                                            
                                            <apex:column headerValue="Item Qty">
                                                <apex:inputText value="{!comp.ComponentQty}" styleClass="col_width_80" />
                                            </apex:column>
                                            <apex:column headerValue="Territory">
                                                <!--<apex:inputField value="{!comp.instance.Territory__c}" />-->
                                                <apex:selectlist value="{!comp.instance.Territory__c}" size="1">
                                                    <apex:selectoptions value="{!comp.lstTerritoryOptions}" />
                                                </apex:selectList>
                                            </apex:column>
                                            <!--<apex:column headerValue="Sub-Format" rendered="{!showMPM}"> 
<apex:inputField value="{!comp.instance.Subformat__c}" >
</apex:inputField>  
</apex:column>-->
                                            
                                            <!-- <apex:column headerValue="Link Components">
<apex:inputField value="{!comp.instance.Association_Required__c}" />
</apex:column>-->
                                        </apex:pageBlockTable>
                                    </apex:outputPanel>
                                </apex:outputPanel>
                                
                                
                                <!--level 2 goes here-->
                                
                                <!-- Level 2 -->
                                <apex:outputPanel id="panel2ndLevel">
                                    <apex:variable var="l2Index" value="{!0}" />
                                    <apex:repeat value="{!material.childIns.Data}" var="material2" id="repeatLevel2">
                                        <!-- Level 2: FERTs -->
                                        <apex:variable var="materialIndexPath2" value="{!TEXT(l1Index) + ';' + TEXT(l2Index)}" />
                                        <apex:outputPanel layout="block" >
                                            <apex:outputPanel layout="block" styleClass="nbcu_rw_table_parent clearfix">
                                                <!-- FERT Details -->
                                                <apex:outputPanel layout="block" styleclass="nbcu_tableset">
                                                    <apex:outputpanel id="plusimage2" style="display:{!if(material2.isCollapsed,"block","none")};" styleclass="nbcu_exapnd_collapse">
                                                        <apex:image url="{!$Resource.Chevron_Right_Green}" >
                                                            <apex:actionSupport event="onclick" reRender="MasterContainer" action="{!sectionCollapseExpand}" status="ajaxStatus" oncomplete="clickNbcuButtonSet();">
                                                                <apex:param value="{!materialIndexPath2}" name="materialIndex2" assignTo="{!materialIndex}" />
                                                                <apex:param value="{!2}" name="bomDepth2" assignTo="{!selectedMaterialLevel}" />
                                                            </apex:actionSupport>                                               
                                                        </apex:image>
                                                    </apex:outputpanel>
                                                    <apex:outputpanel id="minusimage2" style="display:{!if(material2.isCollapsed,"none","block")};" styleclass="nbcu_exapnd_collapse">
                                                        <apex:image url="{!$Resource.Chevron_Down_Green}" >
                                                            <apex:actionSupport event="onclick" reRender="MasterContainer" action="{!sectionCollapseExpand}" status="ajaxStatus" oncomplete="clickNbcuButtonSet();">
                                                                <apex:param value="{!materialIndexPath2}" name="materialIndex2" assignTo="{!materialIndex}" />
                                                                <apex:param value="{!2}" name="bomDepth2" assignTo="{!selectedMaterialLevel}" />
                                                            </apex:actionSupport>                                               
                                                        </apex:image>
                                                    </apex:outputpanel>
                                                    
                                                    <!-- Existing Material -->
                                                    <apex:outputPanel layout="block" styleClass="nbcu_table_rw nbcu_table_existing_material">
                                                        <apex:pageBlockTable value="{!material2}" var="mat" rendered="{!material2.isExistingRecord}">
                                                            <apex:column headerValue="Material Description" styleClass="col_width_200">
                                                                <apex:outputField value="{!mat.instance.Name}" />
                                                            </apex:column>
                                                            <apex:column headerValue="Material Number" styleClass="col_width_100">
                                                                <apex:outputField value="{!mat.instance.Material_Number__c}" />
                                                            </apex:column>
                                                            <apex:column headerValue="Title/SGENNO" styleClass="col_width_100">
                                                                <apex:outputField value="{!mat.instance.Title__c}" /> &nbsp;
                                                                <!--<apex:outputLabel style="font-size: 13px;" value="{!mat.sysgenNo}"></apex:outputlabel>-->
                                                            </apex:column>
                                                            <apex:column headerValue="Item Qty" styleClass="col_width_50">
                                                                <apex:inputText value="{!mat.ComponentQty}" styleClass="col_width_50"/>
                                                            </apex:column>
                                                            <apex:column headerValue="Label Code" styleClass="col_width_100">
                                                                <apex:outputField value="{!mat.instance.Label_Code__c}" />
                                                            </apex:column>
                                                            
                                                            <apex:column headerValue="Territory" styleClass="col_width_30">
                                                                <apex:outputField value="{!mat.instance.Territory__c}" />
                                                            </apex:column>
                                                            <apex:column headerValue="Sub-Format" styleClass="col_width_100" rendered="{!showMPM}">                                             
                                                                <apex:outputField value="{!mat.instance.Subformat__c}" />
                                                            </apex:column>
                                                        </apex:pageBlockTable>
                                                    </apex:outputPanel>
                                                    
                                                    <!-- New FERT -->
                                                    <apex:outputPanel layout="block" styleClass="nbcu_table_rw nbcu_wzd_fmt">
                                                        <apex:pageBlockTable value="{!material2}" var="mat" rendered="{!NOT(material2.isExistingRecord)}">
                                                            <apex:column headerValue="Wizard Format">
                                                                <apex:inputField value="{!mat.instance.Format_Description__c}" style="width:auto;">
                                                                    <apex:actionSupport event="onchange" reRender="MasterContainer" action="{!setTitleDetailsG1200}" status="ajaxStatus" oncomplete="clickNbcuButtonSet();">
                                                                        <apex:param value="{!materialIndexPath2}" name="materialIndex2" assignTo="{!materialIndex}" />
                                                                        <apex:param value="{!2}" name="bomDepth2" assignTo="{!selectedMaterialLevel}" />
                                                                    </apex:actionSupport>
                                                                </apex:inputField>
                                                            </apex:column>
                                                            <apex:column headerValue="Material Type">
                                                                <apex:inputField value="{!mat.instance.Material_Type__c}" style="width:auto;">
                                                                    <apex:actionSupport event="onchange" reRender="MasterContainer" status="ajaxStatus" oncomplete="clickNbcuButtonSet();"/>
                                                                </apex:inputField>
                                                            </apex:column>
                                                            <apex:column headerValue="Item Type">
                                                                <apex:inputField value="{!mat.instance.Item_Type__c}" style="width:auto;">
                                                                    <apex:actionSupport event="onchange" reRender="MasterContainer" action="{!setTitleDetailsG1200}" status="ajaxStatus" oncomplete="clickNbcuButtonSet();">
                                                                        <apex:param value="{!materialIndexPath2}" name="materialIndex2" assignTo="{!materialIndex}" />
                                                                        <apex:param value="{!2}" name="bomDepth2" assignTo="{!selectedMaterialLevel}" />
                                                                    </apex:actionSupport>
                                                                </apex:inputField>
                                                            </apex:column>
                                                            <apex:column headerValue="Item Code">
                                                                <!--<apex:inputField value="{!mat.instance.Item_Code__c}" style="width:auto;" />-->
                                                                <apex:inputField value="{!mat.instance.Item_Code__c}" style="width:auto;">
                                                                      <apex:actionSupport event="onchange" reRender="MasterContainer" action="{!setTitleDetailsG1200}" status="ajaxStatus" oncomplete="clickNbcuButtonSet();">
                                                                           <apex:param value="{!materialIndexPath1}" name="materialIndex1" assignTo="{!materialIndex}" />
                                                                           <apex:param value="{!1}" name="bomDepth1" assignTo="{!selectedMaterialLevel}" />
                                                                      </apex:actionSupport>
                                                                </apex:inputField>
                                                            </apex:column>
                                                            <apex:column headerValue="Title/SGENNO">
                                                                <apex:inputfield value="{!mat.instance.Title__c}" style="width:auto;">
                                                                    <apex:actionSupport event="onchange" reRender="MasterContainer" action="{!setTitleDetails}" status="ajaxStatus" oncomplete="clickNbcuButtonSet();">
                                                                        <apex:param value="{!materialIndexPath2}" name="materialIndex2" assignTo="{!materialIndex}" />
                                                                        <apex:param value="{!2}" name="bomDepth2" assignTo="{!selectedMaterialLevel}" />
                                                                    </apex:actionSupport>
                                                                </apex:inputField>
                                                                <!--<apex:outputLabel value="{!mat.sysgenNo}" />-->
                                                            </apex:column>
                                                            <apex:column headerValue="Retailer/Rental">
                                                                <apex:inputField value="{!mat.instance.Retailer_Rental__c}" style="width:auto;" />
                                                            </apex:column>
                                                            <apex:column headerValue="Item Qty" styleClass="col_width_50">
                                                                <apex:inputText value="{!mat.ComponentQty}" rendered="{!mat.instance.id==null}" styleClass="col_width_50"/>
                                                            </apex:column>
                                                            
                                                            <apex:column headerValue="Territory">
                                                                <apex:inputField value="{!mat.instance.Territory__c}" style="width:auto;">
                                                                    <apex:actionSupport event="onchange" reRender="MasterContainer" status="ajaxStatus" oncomplete="clickNbcuButtonSet();"/>
                                                                </apex:inputField><!--USST-2828 and USST-3161-->
                                                                
                                                            </apex:column>
                                                            
                                                            <apex:column headerValue="Sub-Format" rendered="{!showMPM}"> 
                                                                <apex:inputField value="{!mat.instance.Subformat__c}">
                                                                </apex:inputField>
                                                            </apex:column>
                                                        </apex:pageBlockTable>
                                                    </apex:outputPanel>
                                                </apex:outputPanel>
                                                
                                                <apex:outputPanel layout="block" styleclass="nbcu_commandlink">
                                                    <div class="nbcuButtonSetLabel" style="padding-top:7px;display:{!if(material2.instance.Item_Code__c != 'BF - BABY FERT',"inline","none")};">
                                                        <apex:commandLink action="{!addComponent}" rerender="MasterContainer, pgMsg" rendered="{!material2.instance.Item_Code__c != 'BF - BABY FERT'}" status="ajaxStatus" oncomplete="clickNbcuButtonSet();">
                                                            <span><apex:image id="AddImage" value="{!$Resource.Add}" width="12" /></span>
                                                            <apex:outputText ><b>C</b></apex:outputText>
                                                            <apex:param value="{!materialIndexPath2}" name="addComponent2" assignTo="{!materialIndex}" />
                                                            <apex:param value="{!2}" name="bomDepth2" assignTo="{!selectedMaterialLevel}" />
                                                        </apex:commandLink>
                                                    </div> &nbsp;
                                                    <apex:outputPanel layout="block" styleclass="nbcuButtonSetWrapper">
                                                        <div class="nbcuButtonSet">
                                                            <apex:outputPanel layout="none">
                                                                <label class="nbcuButtonSetLabel"><apex:image url="{!$Resource.Chevron_Down_Btn}" height="16" width="17" /></label>
                                                                
                                                                <div class="nbcuButtonSetMenu">
                                                                    <apex:outputPanel layout="none">
                                                                        <apex:commandLink action="{!addMaterial}" reRender="MasterContainer, pgMsg" status="ajaxStatus" rendered="{!material2.instance.Item_Type__c != 'S (Single)'}" oncomplete="clickNbcuButtonSet();">
                                                                            <span><apex:image id="AddImg" value="{!$Resource.Add}" width="12"/></span>
                                                                            <apex:outputText ><b>New Material</b></apex:outputText>
                                                                            <apex:param value="{!materialIndexPath2}" name="addMaterial2" assignTo="{!materialIndex}" />
                                                                            <apex:param value="{!2}" name="bomDepth2" assignTo="{!selectedMaterialLevel}" />
                                                                        </apex:commandLink>
                                                                        <apex:commandLink reRender="MasterContainer, pgMsg" rendered="{!material2.instance.Item_Code__c != 'BF - BABY FERT'}" status="ajaxStatus" onClick="openListManagementPage('{!material2.instance.Territory__c}', {!material2.isExistingRecord}, '{!material2.instance.Item_Type__c}', '{!material2.instance.BOM_Status__c}', {!material2.hasDChainFR});" oncomplete="clickNbcuButtonSet();">
                                                                            <span><apex:image id="AddImg2" value="{!$Resource.Add}" width="12"/></span>
                                                                            <apex:outputText ><b>Existing Component</b></apex:outputText>
                                                                            <apex:param value="{!materialIndexPath2}" name="openListManagementPage2" assignTo="{!materialIndex}" />
                                                                            <apex:param value="{!2}" name="bomDepth2" assignTo="{!selectedMaterialLevel}" />
                                                                            <apex:param value="COMPONENT" name="materialType2" assignTo="{!materialType}" />
                                                                        </apex:commandLink>
                                                                        <apex:commandLink reRender="MasterContainer, pgMsg" status="ajaxStatus" onClick="openFERTListManagementPage('{!material2.instance.Territory__c}', {!material2.isExistingRecord}, '{!material2.instance.Item_Type__c}', '{!material2.instance.BOM_Status__c}', {!material2.hasDChainFR});"
                                                                                          rendered="{!material2.instance.Item_Type__c != 'S (Single)'}" oncomplete="clickNbcuButtonSet();">
                                                                            <span><apex:image id="AddImg3" value="{!$Resource.Add}" width="12"/></span>
                                                                            <apex:outputText ><b>Existing Material</b></apex:outputText>
                                                                            <apex:param value="{!materialIndexPath2}" name="openFERTListManagementPage2" assignTo="{!materialIndex}" />
                                                                            <apex:param value="{!2}" name="bomDepth2" assignTo="{!selectedMaterialLevel}" />
                                                                            <apex:param value="FERT" name="materialType2" assignTo="{!materialType}" />
                                                                        </apex:commandLink>
                                                                        
                                                                        <!-- Added for RE-20 -->
                                                                        <apex:commandLink action="{!openMultiDiscPopUp}" reRender="MultiDiscPopUp" status="ajaxStatus" rendered="{!material2.instance.Item_Code__c != 'BF - BABY FERT'}" oncomplete="clickNbcuButtonSet();">
                                                                            <span><apex:image id="AddImg4" value="{!$Resource.Add}" width="12"/></span>
                                                                            <apex:outputText ><b>Add Multiple Discs</b></apex:outputText>
                                                                            <apex:param value="{!materialIndexPath2}" name="openPopUp2" assignTo="{!materialIndex}" />
                                                                            <apex:param value="{!2}" name="bomDepth2" assignTo="{!selectedMaterialLevel}" />
                                                                        </apex:commandLink>
                                                                        
                                                                        <apex:commandLink action="{!openPopUp}" reRender="MaterialTreePopUp" status="ajaxStatus" oncomplete="clickNbcuButtonSet();">
                                                                            <span><apex:image id="AddImg1" value="{!$Resource.CheckImg}" width="12"/></span>
                                                                            <apex:outputText ><b>Copy Material Tree</b></apex:outputText>
                                                                            <apex:param value="{!materialIndexPath2}" name="openPopUp2" assignTo="{!materialIndex}" />
                                                                            <apex:param value="{!2}" name="bomDepth2" assignTo="{!selectedMaterialLevel}" />
                                                                        </apex:commandLink>
                                                                        <apex:commandLink action="{!removeFERTs}" reRender="MasterContainer, pgMsg" status="ajaxStatus" oncomplete="clickNbcuButtonSet();">
                                                                            <span><apex:image id="RemoveImage" value="{!$Resource.Remove}" width="12" title="Remove"/></span>
                                                                            <apex:outputText ><b>Remove</b></apex:outputText>
                                                                            <apex:param value="{!materialIndexPath2}" name="removeFERTs2" assignTo="{!materialIndex}" />
                                                                            <apex:param value="{!2}" name="bomDepth2" assignTo="{!selectedMaterialLevel}" />
                                                                        </apex:commandLink>
                                                                    </apex:outputPanel>
                                                                </div>
                                                            </apex:outputPanel>
                                                        </div>
                                                    </apex:outputPanel>
                                                </apex:outputPanel>
                                            </apex:outputPanel>
                                            <!-- Level 2: Components -->
                                            <apex:outputPanel id="inlinetablesec1" rendered="{!NOT(material2.isCollapsed)}" layout="block" styleclass="nbcu_rw_table_child">
                                                <!--outputpanel for all level 2 childs-->
                                                <!-- Existing Components -->
                                                <apex:outputPanel layout="block" rendered="{!material2.existingComponents.size > 0}">
                                                    <apex:outputPanel layout="block" styleclass="nbcu_rw_table nbcu_table_existing_component">
                                                        <apex:variable value="{!0}" var="componentIndex2" />
                                                        <apex:pageBlockTable value="{!material2.existingComponents}" var="comp">
                                                            <apex:column headerValue="Material Description" styleClass="col_width_200">
                                                                <apex:outputField value="{!comp.instance.Name}" />
                                                                <apex:commandLink action="{!removeComponent}" rerender="MasterContainer, pgMsg" status="ajaxStatus" oncomplete="clickNbcuButtonSet();">
                                                                    <span style="padding-left:10px;"><apex:image id="RemoveImage" value="{!$Resource.Remove}" width="10" title="Remove"/></span>
                                                                    <apex:param value="{!comp.localComponentId}" name="componentIndex2" assignTo="{!componentIndex}" />
                                                                    <apex:param value="{!materialIndexPath2}" name="removeComponent2" assignTo="{!materialIndex}" />
                                                                    <apex:param value="{!2}" name="selectedMaterialLevel2" assignTo="{!selectedMaterialLevel}" />
                                                                </apex:commandLink>
                                                                <apex:variable var="componentIndex2" value="{!componentIndex2+ 1}" />
                                                            </apex:column>
                                                            
                                                            <apex:column headerValue="Component Number" styleClass="col_width_100">
                                                                <apex:outputField value="{!comp.instance.Material_Number__c}" />
                                                            </apex:column>
                                                            
                                                            <apex:column headerValue="Item Qty" styleClass="col_width_50">
                                                                <apex:inputText value="{!comp.ComponentQty}" styleClass="col_width_50"/>
                                                            </apex:column>
                                                            
                                                            <apex:column headerValue="Label Code" styleClass="col_width_100">
                                                                <apex:outputField value="{!comp.instance.Label_Code__c}" />
                                                            </apex:column>
                                                            <apex:column headerValue="Territory" styleClass="col_width_30">
                                                                <apex:outputField value="{!comp.instance.Territory__c}" />
                                                            </apex:column>
                                                            <!--<apex:column headerValue="Sub-Format" styleClass="col_width_100" rendered="{!showMPM}">                                            
<apex:outputField value="{!comp.instance.Subformat__c}" />
</apex:column>-->
                                                            
                                                        </apex:pageBlockTable>
                                                    </apex:outputPanel>
                                                </apex:outputPanel>
                                                
                                                <!-- New Components -->
                                                <apex:outputPanel rendered="{!material2.newComponents.size > 0}">
                                                    <apex:outputPanel layout="block" styleclass="nbcu_rw_table">
                                                        <apex:variable value="{!0}" var="componentIndex2" />
                                                        <apex:pageBlockTable value="{!material2.newComponents}" var="comp">
                                                            <apex:column headerValue="Component Type">
                                                                <apex:inputField value="{!comp.instance.Component_Type__c}">
                                                                    <!-- added action support as part of REL-20 changes -->
                                                                    <apex:actionSupport event="onchange" reRender="MasterContainer" action="{!updateTerritoryOfDisc}" status="ajaxStatus" oncomplete="clickNbcuButtonSet();">
                                                                        <apex:param value="{!comp.localComponentId}" name="componentIndex2" assignTo="{!componentIndex}" />
                                                                        <!-- componentIndex1 -->
                                                                        <apex:param value="{!materialIndexPath2}" name="Component2" assignTo="{!materialIndex}" />
                                                                        <apex:param value="{!2}" name="selectedMaterialLevel2" assignTo="{!selectedMaterialLevel}" />
                                                                    </apex:actionSupport>
                                                                </apex:inputField>  
                                                                <apex:commandLink action="{!removeComponent}" rerender="MasterContainer, pgMsg" status="ajaxStatus" oncomplete="clickNbcuButtonSet();">
                                                                    <span style="padding-left:10px;"><apex:image id="RemoveImage" value="{!$Resource.Remove}" width="10" title="Remove"/></span>
                                                                    <apex:param value="{!comp.localComponentId}" name="componentIndex2" assignTo="{!componentIndex}" />
                                                                    <!-- componentIndex1 -->
                                                                    <apex:param value="{!materialIndexPath2}" name="removeComponent2" assignTo="{!materialIndex}" />
                                                                    <apex:param value="{!2}" name="selectedMaterialLevel2" assignTo="{!selectedMaterialLevel}" />
                                                                </apex:commandLink>
                                                                <apex:variable var="componentIndex2" value="{!componentIndex2+ 1}" />
                                                            </apex:column>
                                                            
                                                            <apex:column headerValue="Item Qty">
                                                                <apex:inputText value="{!comp.ComponentQty}" styleClass="col_width_80"/>
                                                            </apex:column>
                                                            <apex:column headerValue="Territory">
                                                                <!--<apex:inputField value="{!comp.instance.Territory__c}" />-->
                                                                <apex:selectlist value="{!comp.instance.Territory__c}" size="1">
                                                                    <apex:selectoptions value="{!comp.lstTerritoryOptions}" />
                                                                </apex:selectList>
                                                            </apex:column>
                                                            <!--<apex:column headerValue="Sub-Format" rendered="{!showMPM}"> 
<apex:inputField value="{!comp.instance.Subformat__c}" >
</apex:inputField>  
</apex:column>-->
                                                        </apex:pageBlockTable>
                                                    </apex:outputPanel>
                                                </apex:outputPanel>
                                                
                                                <!--Level 3 goes here-->
                                                
                                                <!-- Level 3 -->
                                                <apex:outputPanel id="panel3rdLevel">
                                                    <apex:variable var="l3Index" value="{!0}" />
                                                    <apex:repeat value="{!material2.childIns.Data}" var="material3" id="repeatLevel3">
                                                        <!-- Level 3: FERTs -->
                                                        <apex:variable var="materialIndexPath3" value="{!TEXT(l1Index) + ';' + TEXT(l2Index) + ';' + TEXT(l3Index)}" />
                                                        <apex:outputpanel layout="block" >
                                                            <apex:outputPanel layout="block" styleclass="nbcu_rw_table_parent clearfix">
                                                                <!-- FERT Details -->
                                                                <apex:outputPanel layout="block" styleclass="nbcu_tableset">
                                                                    <apex:outputpanel id="plusimage3" style="display:{!if(material3.isCollapsed,"block","none")};" styleclass="nbcu_exapnd_collapse">
                                                                        <apex:image url="{!$Resource.Chevron_Right_Purple}" >
                                                                            <apex:actionSupport event="onclick" reRender="MasterContainer" action="{!sectionCollapseExpand}" status="ajaxStatus" oncomplete="clickNbcuButtonSet();">
                                                                                <apex:param value="{!materialIndexPath3}" name="materialIndex3" assignTo="{!materialIndex}" />
                                                                                <apex:param value="{!3}" name="bomDepth3" assignTo="{!selectedMaterialLevel}" />
                                                                            </apex:actionSupport>
                                                                        </apex:image>
                                                                    </apex:outputpanel>
                                                                    <apex:outputpanel id="minusimage3" style="display:{!if(material3.isCollapsed,"none","block")};" styleclass="nbcu_exapnd_collapse">
                                                                        <apex:image url="{!$Resource.Chevron_Down_Purple}" >
                                                                            <apex:actionSupport event="onclick" reRender="MasterContainer" action="{!sectionCollapseExpand}" status="ajaxStatus" oncomplete="clickNbcuButtonSet();">
                                                                                <apex:param value="{!materialIndexPath3}" name="materialIndex3" assignTo="{!materialIndex}" />
                                                                                <apex:param value="{!3}" name="bomDepth3" assignTo="{!selectedMaterialLevel}" />
                                                                            </apex:actionSupport>
                                                                        </apex:image>
                                                                    </apex:outputpanel>
                                                                    <!-- Existing Material -->
                                                                    <apex:outputPanel layout="block" styleClass="nbcu_table_rw nbcu_table_existing_material">
                                                                        <apex:pageBlockTable value="{!material3}" var="mat" rendered="{!material3.isExistingRecord}">
                                                                            <apex:column headerValue="Material Description" styleClass="col_width_200">
                                                                                <apex:outputField value="{!mat.instance.Name}" />
                                                                            </apex:column>
                                                                            <apex:column headerValue="Material Number" styleClass="col_width_100">
                                                                                <apex:outputField value="{!mat.instance.Material_Number__c}" />
                                                                            </apex:column>
                                                                            <apex:column headerValue="Title/SGENNO" styleClass="col_width_100">
                                                                                <apex:outputField value="{!mat.instance.Title__c}" /> &nbsp;
                                                                                <!--<apex:outputLabel style="font-size: 13px;" value="{!mat.sysgenNo}"></apex:outputlabel>-->
                                                                            </apex:column>
                                                                            <apex:column headerValue="Item Qty" styleClass="col_width_50">
                                                                                <apex:inputText value="{!mat.ComponentQty}" styleClass="col_width_50"/>
                                                                            </apex:column>
                                                                            <apex:column headerValue="Label Code" styleClass="col_width_100">
                                                                                <apex:outputField value="{!mat.instance.Label_Code__c}" />
                                                                            </apex:column>
                                                                            
                                                                            <apex:column headerValue="Territory" styleClass="col_width_30">
                                                                                <apex:outputField value="{!mat.instance.Territory__c}" />
                                                                            </apex:column>
                                                                            <apex:column headerValue="Sub-Format" styleClass="col_width_100" rendered="{!showMPM}">                                             
                                                                                <apex:outputField value="{!mat.instance.Subformat__c}" />
                                                                            </apex:column>
                                                                        </apex:pageBlockTable>
                                                                    </apex:outputPanel>
                                                                    
                                                                    <!-- New FERT -->
                                                                    <apex:outputPanel layout="block" styleClass="nbcu_table_rw nbcu_wzd_fmt">
                                                                        <apex:pageBlockTable value="{!material3}" var="mat" rendered="{!NOT(material3.isExistingRecord)}">
                                                                            <apex:column headerValue="Wizard Format">
                                                                                <apex:inputField value="{!mat.instance.Format_Description__c}" style="width:auto;">
                                                                                    <apex:actionSupport event="onchange" reRender="MasterContainerPanel" action="{!setTitleDetailsG1200}" status="ajaxStatus" oncomplete="clickNbcuButtonSet();">
                                                                                        <apex:param value="{!materialIndexPath3}" name="materialIndex3" assignTo="{!materialIndex}" />
                                                                                        <apex:param value="{!3}" name="bomDepth3" assignTo="{!selectedMaterialLevel}" />
                                                                                    </apex:actionSupport>
                                                                                </apex:inputField>
                                                                            </apex:column>
                                                                            <apex:column headerValue="Material Type">
                                                                                <apex:inputField value="{!mat.instance.Material_Type__c}" style="width:auto;">
                                                                                    <apex:actionSupport event="onchange" reRender="MasterContainer" status="ajaxStatus" oncomplete="clickNbcuButtonSet();"/>
                                                                                </apex:inputField>
                                                                            </apex:column>
                                                                            <apex:column headerValue="Item Type">
                                                                                <apex:inputField value="{!mat.instance.Item_Type__c}" style="width:auto;">
                                                                                    <apex:actionSupport event="onchange" reRender="MasterContainerPanel" action="{!setTitleDetailsG1200}" status="ajaxStatus" oncomplete="clickNbcuButtonSet();">
                                                                                        <apex:param value="{!materialIndexPath3}" name="materialIndex3" assignTo="{!materialIndex}" />
                                                                                        <apex:param value="{!3}" name="bomDepth3" assignTo="{!selectedMaterialLevel}" />
                                                                                    </apex:actionSupport>
                                                                                </apex:inputField>
                                                                            </apex:column>
                                                                            <apex:column headerValue="Item Code">
                                                                                <!--<apex:inputField value="{!mat.instance.Item_Code__c}" style="width:auto;" />-->
                                                                                <apex:inputField value="{!mat.instance.Item_Code__c}" style="width:auto;">
                                                                                    <apex:actionSupport event="onchange" reRender="MasterContainer" action="{!setTitleDetailsG1200}" status="ajaxStatus" oncomplete="clickNbcuButtonSet();">
                                                                                        <apex:param value="{!materialIndexPath1}" name="materialIndex1" assignTo="{!materialIndex}" />
                                                                                        <apex:param value="{!1}" name="bomDepth1" assignTo="{!selectedMaterialLevel}" />
                                                                                    </apex:actionSupport>
                                                                                </apex:inputField>
                                                                            </apex:column>
                                                                            <apex:column headerValue="Title/SGENNO">
                                                                                <apex:inputfield value="{!mat.instance.Title__c}" style="width:auto;">
                                                                                    <apex:actionSupport event="onchange" reRender="MasterContainer" action="{!setTitleDetails}" status="ajaxStatus" oncomplete="clickNbcuButtonSet();">
                                                                                        <apex:param value="{!materialIndexPath3}" name="materialIndex3" assignTo="{!materialIndex}" />
                                                                                        <apex:param value="{!3}" name="bomDepth3" assignTo="{!selectedMaterialLevel}" />
                                                                                    </apex:actionSupport>
                                                                                </apex:inputField>
                                                                                <!--<apex:outputLabel value="{!mat.sysgenNo}" />-->
                                                                            </apex:column>
                                                                            <apex:column headerValue="Retailer/Rental">
                                                                                <apex:inputField value="{!mat.instance.Retailer_Rental__c}" style="width:auto;" />
                                                                            </apex:column>
                                                                            <apex:column headerValue="Item Qty" styleClass="col_width_50">
                                                                                <apex:inputText value="{!mat.ComponentQty}" rendered="{!mat.instance.id==null}" styleClass="col_width_50"/>
                                                                            </apex:column>
                                                                            
                                                                            <apex:column headerValue="Territory">
                                                                                <apex:inputField value="{!mat.instance.Territory__c}" style="width:auto;">
                                                                                    <apex:actionSupport event="onchange" reRender="MasterContainer" status="ajaxStatus" oncomplete="clickNbcuButtonSet();"/>
                                                                                </apex:inputField><!--USST-2828 and USST-3161-->
                                                                            </apex:column>
                                                                            <apex:column headerValue="Sub-Format" rendered="{!showMPM}"> 
                                                                                <apex:inputField value="{!mat.instance.Subformat__c}">
                                                                                </apex:inputField>
                                                                            </apex:column>
                                                                        </apex:pageBlockTable>
                                                                    </apex:outputPanel>
                                                                </apex:outputPanel>
                                                                
                                                                <apex:outputPanel layout="block" styleclass="nbcu_commandlink">
                                                                    <div class="nbcuButtonSetLabel" style="padding-top:7px;display:{!if(material3.instance.Item_Code__c != 'BF - BABY FERT',"inline","none")};">
                                                                        <apex:commandLink action="{!addComponent}" rerender="MasterContainer, pgMsg" rendered="{!material3.instance.Item_Code__c != 'BF - BABY FERT'}" status="ajaxStatus" oncomplete="clickNbcuButtonSet();">
                                                                            <span><apex:image id="AddImage" value="{!$Resource.Add}" width="12" /></span>
                                                                            <apex:outputText ><b>C</b></apex:outputText>
                                                                            <apex:param value="{!materialIndexPath3}" name="addComponent3" assignTo="{!materialIndex}" />
                                                                            <apex:param value="{!3}" name="bomDepth3" assignTo="{!selectedMaterialLevel}" />
                                                                        </apex:commandLink>
                                                                    </div> &nbsp;
                                                                    <apex:outputPanel layout="block" styleclass="nbcuButtonSetWrapper">
                                                                        <div class="nbcuButtonSet">
                                                                            <apex:outputPanel layout="none">
                                                                                <label class="nbcuButtonSetLabel"><apex:image url="{!$Resource.Chevron_Down_Btn}" height="16" width="17" /></label>
                                                                                
                                                                                <div class="nbcuButtonSetMenu">
                                                                                    <apex:outputPanel layout="none">
                                                                                        <apex:commandLink action="{!addMaterial}" reRender="MasterContainer, pgMsg" status="ajaxStatus" rendered="{!material3.instance.Item_Type__c != 'S (Single)'}"  oncomplete="clickNbcuButtonSet();">
                                                                                            <span><apex:image id="AddImg" value="{!$Resource.Add}" width="12"/></span>
                                                                                            <apex:outputText ><b>New Material</b></apex:outputText>
                                                                                            <apex:param value="{!materialIndexPath3}" name="addMaterial3" assignTo="{!materialIndex}" />
                                                                                            <apex:param value="{!3}" name="bomDepth3" assignTo="{!selectedMaterialLevel}" />
                                                                                        </apex:commandLink>
                                                                                        <apex:commandLink reRender="MasterContainer, pgMsg" status="ajaxStatus" rendered="{!material3.instance.Item_Code__c != 'BF - BABY FERT'}" onClick="openListManagementPage('{!material3.instance.Territory__c}', {!material3.isExistingRecord}, '{!material3.instance.Item_Type__c}', '{!material3.instance.BOM_Status__c}', {!material3.hasDChainFR});" oncomplete="clickNbcuButtonSet();">
                                                                                            <span><apex:image id="AddImg2" value="{!$Resource.Add}" width="12"/></span>
                                                                                            <apex:outputText ><b>Existing Component</b></apex:outputText>
                                                                                            <apex:param value="{!materialIndexPath3}" name="openListManagementPage3" assignTo="{!materialIndex}" />
                                                                                            <apex:param value="{!3}" name="bomDepth3" assignTo="{!selectedMaterialLevel}" />
                                                                                            <apex:param value="COMPONENT" name="materialType3" assignTo="{!materialType}" />
                                                                                        </apex:commandLink>
                                                                                        <apex:commandLink reRender="MasterContainer, pgMsg" status="ajaxStatus" onClick="openFERTListManagementPage('{!material3.instance.Territory__c}', {!material3.isExistingRecord}, '{!material3.instance.Item_Type__c}', '{!material3.instance.BOM_Status__c}', {!material3.hasDChainFR});"
                                                                                                          rendered="{!material3.instance.Item_Type__c != 'S (Single)'}" oncomplete="clickNbcuButtonSet();">
                                                                                            <span><apex:image id="AddImg3" value="{!$Resource.Add}" width="12"/></span>
                                                                                            <apex:outputText ><b>Existing Material</b></apex:outputText>
                                                                                            <apex:param value="{!materialIndexPath3}" name="openFERTListManagementPage3" assignTo="{!materialIndex}" />
                                                                                            <apex:param value="{!3}" name="bomDepth3" assignTo="{!selectedMaterialLevel}" />
                                                                                            <apex:param value="FERT" name="materialType3" assignTo="{!materialType}" />
                                                                                        </apex:commandLink>
                                                                                        
                                                                                        <!-- Added for RE-20 -->
                                                                                        <apex:commandLink action="{!openMultiDiscPopUp}" reRender="MultiDiscPopUp" status="ajaxStatus" rendered="{!material3.instance.Item_Code__c != 'BF - BABY FERT'}" oncomplete="clickNbcuButtonSet();">
                                                                                            <span><apex:image id="AddImg4" value="{!$Resource.Add}" width="12"/></span>
                                                                                            <apex:outputText ><b>Add Multiple Discs</b></apex:outputText>
                                                                                            <apex:param value="{!materialIndexPath3}" name="openPopUp3" assignTo="{!materialIndex}" />
                                                                                            <apex:param value="{!3}" name="bomDepth3" assignTo="{!selectedMaterialLevel}" />
                                                                                        </apex:commandLink>
                                                                                        
                                                                                        <apex:commandLink action="{!openPopUp}" reRender="MaterialTreePopUp" status="ajaxStatus" oncomplete="clickNbcuButtonSet();">
                                                                                            <span><apex:image id="AddImg1" value="{!$Resource.CheckImg}" width="12"/></span>
                                                                                            <apex:outputText ><b>Copy Material Tree</b></apex:outputText>
                                                                                            <apex:param value="{!materialIndexPath3}" name="openPopUp3" assignTo="{!materialIndex}" />
                                                                                            <apex:param value="{!3}" name="bomDepth3" assignTo="{!selectedMaterialLevel}" />
                                                                                        </apex:commandLink>
                                                                                        <apex:commandLink action="{!removeFERTs}" reRender="MasterContainer, pgMsg" status="ajaxStatus" oncomplete="clickNbcuButtonSet();">
                                                                                            <span><apex:image id="RemoveImage" value="{!$Resource.Remove}" width="12" title="Remove"/></span>
                                                                                            <apex:outputText ><b>Remove</b></apex:outputText>
                                                                                            <apex:param value="{!materialIndexPath3}" name="removeFERTs3" assignTo="{!materialIndex}" />
                                                                                            <apex:param value="{!3}" name="bomDepth3" assignTo="{!selectedMaterialLevel}" />
                                                                                        </apex:commandLink>
                                                                                    </apex:outputPanel>
                                                                                </div>
                                                                            </apex:outputPanel>
                                                                        </div>
                                                                    </apex:outputPanel>
                                                                </apex:outputPanel>
                                                            </apex:outputPanel>
                                                            <!-- Level 3: Components -->
                                                            
                                                            <!-- Existing Components -->
                                                            <apex:outputPanel id="inlinetablesec2" rendered="{!NOT(material3.isCollapsed)}" layout="block" styleclass="nbcu_rw_table_child clearfix">
                                                                <!--outputpanel for all level 3 childs-->
                                                                <apex:outputPanel layout="block" rendered="{!material3.existingComponents.size > 0}">
                                                                    <apex:outputPanel layout="block" styleclass="nbcu_rw_table nbcu_table_existing_component">
                                                                        <apex:variable value="{!0}" var="componentIndex3" />
                                                                        <apex:pageBlockTable value="{!material3.existingComponents}" var="comp">
                                                                            <apex:column headerValue="Material Description" styleClass="col_width_200">
                                                                                <apex:outputField value="{!comp.instance.Name}" />
                                                                                <apex:commandLink action="{!removeComponent}" rerender="MasterContainer, pgMsg" status="ajaxStatus" oncomplete="clickNbcuButtonSet();">
                                                                                    <span style="padding-left:10px;"><apex:image id="RemoveImage" value="{!$Resource.Remove}" width="10" title="Remove"/></span>
                                                                                    <apex:param value="{!comp.localComponentId}" name="componentIndex3" assignTo="{!componentIndex}" />
                                                                                    <apex:param value="{!materialIndexPath3}" name="removeComponent3" assignTo="{!materialIndex}" />
                                                                                    <apex:param value="{!3}" name="selectedMaterialLevel3" assignTo="{!selectedMaterialLevel}" />
                                                                                </apex:commandLink>
                                                                                <apex:variable var="componentIndex3" value="{!componentIndex3+ 1}" />
                                                                            </apex:column>
                                                                            
                                                                            <apex:column headerValue="Component Number" styleClass="col_width_100">
                                                                                <apex:outputField value="{!comp.instance.Material_Number__c}" />
                                                                            </apex:column>
                                                                            
                                                                            <apex:column headerValue="Item Qty" styleClass="col_width_50">
                                                                                <apex:inputText value="{!comp.ComponentQty}" styleClass="col_width_50"/>
                                                                            </apex:column>
                                                                            
                                                                            <apex:column headerValue="Label Code" styleClass="col_width_100">
                                                                                <apex:outputField value="{!comp.instance.Label_Code__c}" />
                                                                            </apex:column>
                                                                            <apex:column headerValue="Territory" styleClass="col_width_30">
                                                                                <apex:outputField value="{!comp.instance.Territory__c}" />
                                                                            </apex:column>                                                                            
                                                                        </apex:pageBlockTable>
                                                                    </apex:outputPanel>
                                                                </apex:outputPanel>
                                                                
                                                                <!-- New Components -->
                                                                <apex:outputPanel layout="block" rendered="{!material3.newComponents.size > 0}">
                                                                    <apex:outputPanel layout="block" styleclass="nbcu_rw_table">
                                                                        <apex:variable value="{!0}" var="componentIndex3" />
                                                                        <apex:pageBlockTable value="{!material3.newComponents}" var="comp">
                                                                            <apex:column headerValue="Component Type">
                                                                                <apex:inputField value="{!comp.instance.Component_Type__c}">
                                                                                    <!-- added action support as part of REL-20 changes -->
                                                                                    <apex:actionSupport event="onchange" reRender="MasterContainer" action="{!updateTerritoryOfDisc}" status="ajaxStatus" oncomplete="clickNbcuButtonSet();">
                                                                                        <apex:param value="{!comp.localComponentId}" name="componentIndex3" assignTo="{!componentIndex}" />
                                                                                        <!-- componentIndex1 -->
                                                                                        <apex:param value="{!materialIndexPath3}" name="Component3" assignTo="{!materialIndex}" />
                                                                                        <apex:param value="{!3}" name="selectedMaterialLevel3" assignTo="{!selectedMaterialLevel}" />
                                                                                    </apex:actionSupport>
                                                                                </apex:inputField>
                                                                                <apex:commandLink action="{!removeComponent}" rerender="MasterContainer, pgMsg" status="ajaxStatus" oncomplete="clickNbcuButtonSet();">
                                                                                    <span style="padding-left:10px;"><apex:image id="RemoveImage" value="{!$Resource.Remove}" width="10" title="Remove"/></span>
                                                                                    <apex:param value="{!comp.localComponentId}" name="componentIndex3" assignTo="{!componentIndex}" />
                                                                                    <!-- componentIndex1 -->
                                                                                    <apex:param value="{!materialIndexPath3}" name="removeComponent3" assignTo="{!materialIndex}" />
                                                                                    <apex:param value="{!3}" name="selectedMaterialLevel3" assignTo="{!selectedMaterialLevel}" />
                                                                                </apex:commandLink>
                                                                                <apex:variable var="componentIndex3" value="{!componentIndex3 + 1}" />
                                                                            </apex:column>
                                                                            
                                                                            <apex:column headerValue="Item Qty">
                                                                                <apex:inputText value="{!comp.ComponentQty}" styleClass="col_width_80"/>
                                                                            </apex:column>
                                                                            <apex:column headerValue="Territory">
                                                                                <!--<apex:inputField value="{!comp.instance.Territory__c}" />-->
                                                                                <apex:selectlist value="{!comp.instance.Territory__c}" size="1">
                                                                                    <apex:selectoptions value="{!comp.lstTerritoryOptions}" />
                                                                                </apex:selectList>
                                                                            </apex:column>
                                                                        </apex:pageBlockTable>
                                                                    </apex:outputPanel>
                                                                </apex:outputPanel>
                                                                
                                                                <!--Level 4 goes here-->
                                                                
                                                                <!-- Level 4 -->
                                                                <apex:outputPanel id="panel4thLevel">
                                                                    <apex:variable var="l4Index" value="{!0}" />
                                                                    <apex:repeat value="{!material3.childIns.Data}" var="material4" id="repeatLevel4">
                                                                        <!-- Level 4: FERTs -->
                                                                        <apex:variable var="materialIndexPath4" value="{!TEXT(l1Index) + ';' + TEXT(l2Index) + ';' + TEXT(l3Index) + ';' + TEXT(l4Index)}"
                                                                                       />
                                                                        <apex:outputPanel >
                                                                            <apex:outputPanel layout="block" styleclass="nbcu_rw_table_parent clearfix">
                                                                                <!-- FERT Details -->
                                                                                <apex:outputPanel layout="block" styleclass="nbcu_tableset">
                                                                                    <apex:outputpanel id="plusimage4" style="display:{!if(material4.isCollapsed,"block","none")};" styleclass="nbcu_exapnd_collapse">
                                                                                        <apex:image url="{!$Resource.Chevron_Right_Yellow}" >
                                                                                            <apex:actionSupport event="onclick" reRender="MasterContainer" action="{!sectionCollapseExpand}" status="ajaxStatus" oncomplete="clickNbcuButtonSet();">
                                                                                                <apex:param value="{!materialIndexPath4}" name="materialIndex4" assignTo="{!materialIndex}" />
                                                                                                <apex:param value="{!4}" name="bomDepth4" assignTo="{!selectedMaterialLevel}" />
                                                                                            </apex:actionSupport>
                                                                                        </apex:image>
                                                                                    </apex:outputpanel>
                                                                                    <apex:outputpanel id="minusimage4" style="display:{!if(material4.isCollapsed,"none","block")};" styleclass="nbcu_exapnd_collapse">
                                                                                        <apex:image url="{!$Resource.Chevron_Down_Yellow}">
                                                                                            <apex:actionSupport event="onclick" reRender="MasterContainer" action="{!sectionCollapseExpand}" status="ajaxStatus" oncomplete="clickNbcuButtonSet();">
                                                                                                <apex:param value="{!materialIndexPath4}" name="materialIndex4" assignTo="{!materialIndex}" />
                                                                                                <apex:param value="{!4}" name="bomDepth4" assignTo="{!selectedMaterialLevel}" />
                                                                                            </apex:actionSupport>
                                                                                        </apex:image>
                                                                                    </apex:outputpanel>
                                                                                    <!-- Existing Material -->
                                                                                    <apex:outputPanel layout="block" styleClass="nbcu_table_rw nbcu_table_existing_material">
                                                                                        <apex:pageBlockTable value="{!material4}" var="mat" rendered="{!material4.isExistingRecord}">
                                                                                            <apex:column headerValue="Material Description" styleClass="col_width_200">
                                                                                                <apex:outputField value="{!mat.instance.Name}" />
                                                                                            </apex:column>
                                                                                            <apex:column headerValue="Material Number" styleClass="col_width_100">
                                                                                                <apex:outputField value="{!mat.instance.Material_Number__c}" />
                                                                                            </apex:column>
                                                                                            <apex:column headerValue="Title/SGENNO" styleClass="col_width_100">
                                                                                                <apex:outputField value="{!mat.instance.Title__c}" /> &nbsp;
                                                                                                <!--<apex:outputLabel style="font-size: 13px;" value="{!mat.sysgenNo}"></apex:outputlabel>-->
                                                                                            </apex:column>
                                                                                            <apex:column headerValue="Item Qty" styleClass="col_width_50">
                                                                                                <apex:inputText value="{!mat.ComponentQty}" styleClass="col_width_50" />
                                                                                            </apex:column>
                                                                                            <apex:column headerValue="Label Code" styleClass="col_width_100">
                                                                                                <apex:outputField value="{!mat.instance.Label_Code__c}"/>
                                                                                            </apex:column>
                                                                                            
                                                                                            <apex:column headerValue="Territory" styleClass="col_width_30">
                                                                                                <apex:outputField value="{!mat.instance.Territory__c}" />
                                                                                            </apex:column>
                                                                                            <apex:column headerValue="Sub-Format" styleClass="col_width_100" rendered="{!showMPM}">                                             
                                                                                                <apex:outputField value="{!mat.instance.Subformat__c}" />
                                                                                            </apex:column>
                                                                                        </apex:pageBlockTable>
                                                                                    </apex:outputPanel>
                                                                                    
                                                                                    <!-- New FERT -->
                                                                                    <apex:outputPanel layout="block" styleClass="nbcu_table_rw nbcu_wzd_fmt">
                                                                                        <apex:pageBlockTable value="{!material4}" var="mat" rendered="{!NOT(material4.isExistingRecord)}">
                                                                                            <apex:column headerValue="Wizard Format">
                                                                                                <apex:inputField value="{!mat.instance.Format_Description__c}" style="width:auto;">
                                                                                                    <apex:actionSupport event="onchange" reRender="MasterContainerPanel" action="{!setTitleDetailsG1200}" status="ajaxStatus" oncomplete="clickNbcuButtonSet();">
                                                                                                        <apex:param value="{!materialIndexPath4}" name="materialIndex4" assignTo="{!materialIndex}" />
                                                                                                        <apex:param value="{!4}" name="bomDepth4" assignTo="{!selectedMaterialLevel}" />
                                                                                                    </apex:actionSupport>
                                                                                                </apex:inputField>
                                                                                            </apex:column>
                                                                                            <apex:column headerValue="Material Type">
                                                                                                <apex:inputField value="{!mat.instance.Material_Type__c}" style="width:auto;">
                                                                                                    <apex:actionSupport event="onchange" reRender="MasterContainer" status="ajaxStatus" oncomplete="clickNbcuButtonSet();"/>
                                                                                                </apex:inputField>
                                                                                                <apex:outputField value="{!mat.instance.Material_Type__c}" rendered="{!mat.isExistingRecord}" />
                                                                                            </apex:column>
                                                                                            <apex:column headerValue="Item Type">
                                                                                                <apex:inputField value="{!mat.instance.Item_Type__c}" style="width:auto;">
                                                                                                    <apex:actionSupport event="onchange" reRender="MasterContainerPanel" action="{!setTitleDetailsG1200}" status="ajaxStatus" oncomplete="clickNbcuButtonSet();">
                                                                                                        <apex:param value="{!materialIndexPath4}" name="materialIndex4" assignTo="{!materialIndex}" />
                                                                                                        <apex:param value="{!4}" name="bomDepth4" assignTo="{!selectedMaterialLevel}" />
                                                                                                    </apex:actionSupport>
                                                                                                </apex:inputField>
                                                                                            </apex:column>
                                                                                            <apex:column headerValue="Item Code">
                                                                                                <!--<apex:inputField value="{!mat.instance.Item_Code__c}" style="width:auto;" />-->
                                                                                                <apex:inputField value="{!mat.instance.Item_Code__c}" style="width:auto;">
                                                                                                    <apex:actionSupport event="onchange" reRender="MasterContainer" action="{!setTitleDetailsG1200}" status="ajaxStatus" oncomplete="clickNbcuButtonSet();">
                                                                                                        <apex:param value="{!materialIndexPath1}" name="materialIndex1" assignTo="{!materialIndex}" />
                                                                                                        <apex:param value="{!1}" name="bomDepth1" assignTo="{!selectedMaterialLevel}" />
                                                                                                    </apex:actionSupport>
                                                                                                </apex:inputField>
                                                                                            </apex:column>
                                                                                            <apex:column headerValue="Title/SGENNO">
                                                                                                <apex:inputfield value="{!mat.instance.Title__c}" style="width:auto;">
                                                                                                    <apex:actionSupport event="onchange" reRender="MasterContainer" action="{!setTitleDetails}" status="ajaxStatus" oncomplete="clickNbcuButtonSet();">
                                                                                                        <apex:param value="{!materialIndexPath4}" name="materialIndex4" assignTo="{!materialIndex}" />
                                                                                                        <apex:param value="{!4}" name="bomDepth4" assignTo="{!selectedMaterialLevel}" />
                                                                                                    </apex:actionSupport>
                                                                                                </apex:inputField>
                                                                                                <!--<apex:outputLabel value="{!mat.sysgenNo}" />-->
                                                                                            </apex:column>
                                                                                            <apex:column headerValue="Retailer/Rental">
                                                                                                <apex:inputField value="{!mat.instance.Retailer_Rental__c}" style="width:auto;" />
                                                                                            </apex:column>
                                                                                            <apex:column headerValue="Item Qty" styleClass="col_width_50">
                                                                                                <apex:inputText value="{!mat.ComponentQty}" rendered="{!mat.instance.id==null}" styleClass="col_width_50" />
                                                                                            </apex:column>
                                                                                            
                                                                                            <apex:column headerValue="Territory">
                                                                                                <apex:inputField value="{!mat.instance.Territory__c}" style="width:auto;">
                                                                                                    <apex:actionSupport event="onchange" reRender="MasterContainer" status="ajaxStatus" oncomplete="clickNbcuButtonSet();"/>
                                                                                                </apex:inputField><!--USST-2828 and USST-3161-->
                                                                                            </apex:column>
                                                                                            <apex:column headerValue="Sub-Format" rendered="{!showMPM}"> 
                                                                                                <apex:inputField value="{!mat.instance.Subformat__c}">
                                                                                                </apex:inputField>
                                                                                            </apex:column>
                                                                                        </apex:pageBlockTable>
                                                                                    </apex:outputPanel>
                                                                                </apex:outputPanel>
                                                                                
                                                                                <apex:outputPanel layout="block" styleclass="nbcu_commandlink">
                                                                                    <div class="nbcuButtonSetLabel" style="padding-top:7px;display:{!if(material4.instance.Item_Code__c != 'BF - BABY FERT',"inline","none")};">
                                                                                        <apex:commandLink action="{!addComponent}" rerender="MasterContainer, pgMsg" rendered="{!material4.instance.Item_Code__c != 'BF - BABY FERT'}" status="ajaxStatus" oncomplete="clickNbcuButtonSet();">
                                                                                            <span><apex:image id="AddImage" value="{!$Resource.Add}" width="12" /></span>
                                                                                            <apex:outputText ><b>C</b></apex:outputText>
                                                                                            <apex:param value="{!materialIndexPath4}" name="addComponent4" assignTo="{!materialIndex}" />
                                                                                            <apex:param value="{!4}" name="bomDepth4" assignTo="{!selectedMaterialLevel}" />
                                                                                        </apex:commandLink>
                                                                                    </div> &nbsp;
                                                                                    <apex:outputPanel layout="block" styleclass="nbcuButtonSetWrapper">
                                                                                        <div class="nbcuButtonSet">
                                                                                            <apex:outputPanel layout="none">
                                                                                                <label class="nbcuButtonSetLabel"><apex:image url="{!$Resource.Chevron_Down_Btn}" height="16" width="17" /></label>
                                                                                                
                                                                                                <div class="nbcuButtonSetMenu">
                                                                                                    <apex:outputPanel layout="none">
                                                                                                        <apex:commandLink reRender="MasterContainer, pgMsg" status="ajaxStatus" rendered="{!material4.instance.Item_Code__c != 'BF - BABY FERT'}" onClick="openListManagementPage('{!material4.instance.Territory__c}', {!material4.isExistingRecord}, '{!material4.instance.Item_Type__c}', '{!material4.instance.BOM_Status__c}', {!material4.hasDChainFR});" oncomplete="clickNbcuButtonSet();">
                                                                                                            <span><apex:image id="AddImg2" value="{!$Resource.Add}" width="12"/></span>
                                                                                                            <apex:outputText ><b>Existing Component</b></apex:outputText>
                                                                                                            <apex:param value="{!materialIndexPath4}" name="openListManagementPage4" assignTo="{!materialIndex}" />
                                                                                                            <apex:param value="{!4}" name="bomDepth4" assignTo="{!selectedMaterialLevel}" />
                                                                                                            <apex:param value="COMPONENT" name="materialType4" assignTo="{!materialType}" />
                                                                                                        </apex:commandLink>
                                                                                                        
                                                                                                        <!-- Added for RE-20 -->
                                                                                                        <apex:commandLink action="{!openMultiDiscPopUp}" reRender="MultiDiscPopUp" status="ajaxStatus" rendered="{!material4.instance.Item_Code__c != 'BF - BABY FERT'}" oncomplete="clickNbcuButtonSet();">
                                                                                                            <span><apex:image id="AddImg4" value="{!$Resource.Add}" width="12"/></span>
                                                                                                            <apex:outputText ><b>Add Multiple Discs</b></apex:outputText>
                                                                                                            <apex:param value="{!materialIndexPath4}" name="openPopUp4" assignTo="{!materialIndex}" />
                                                                                                            <apex:param value="{!4}" name="bomDepth4" assignTo="{!selectedMaterialLevel}" />
                                                                                                        </apex:commandLink>
                                                                                                        
                                                                                                        <apex:commandLink action="{!openPopUp}" reRender="MaterialTreePopUp" status="ajaxStatus" oncomplete="clickNbcuButtonSet();">
                                                                                                            <span><apex:image id="AddImg1" value="{!$Resource.CheckImg}" width="12"/></span>
                                                                                                            <apex:outputText ><b>Copy Material Tree</b></apex:outputText>
                                                                                                            <apex:param value="{!materialIndexPath4}" name="openPopUp4" assignTo="{!materialIndex}" />
                                                                                                            <apex:param value="{!4}" name="bomDepth4" assignTo="{!selectedMaterialLevel}" />
                                                                                                        </apex:commandLink>
                                                                                                        <apex:commandLink action="{!removeFERTs}" reRender="MasterContainer, pgMsg" status="ajaxStatus" oncomplete="clickNbcuButtonSet();">
                                                                                                            <span><apex:image id="RemoveImage" value="{!$Resource.Remove}" width="12" title="Remove"/></span>
                                                                                                            <apex:outputText ><b>Remove</b></apex:outputText>
                                                                                                            <apex:param value="{!materialIndexPath4}" name="removeFERTs4" assignTo="{!materialIndex}" />
                                                                                                            <apex:param value="{!4}" name="bomDepth4" assignTo="{!selectedMaterialLevel}" />
                                                                                                        </apex:commandLink>
                                                                                                    </apex:outputPanel>
                                                                                                </div>
                                                                                            </apex:outputPanel>
                                                                                        </div>
                                                                                    </apex:outputPanel>
                                                                                </apex:outputPanel>
                                                                            </apex:outputPanel>
                                                                            <!-- Level 4: Components -->
                                                                            
                                                                            <!-- Existing Components -->
                                                                            <apex:outputPanel id="inlinetablesec3" rendered="{!NOT(material4.isCollapsed)}"  layout="block" styleclass="nbcu_rw_table_child clearfix">
                                                                                <!--outputpanel for all level 4 childs-->
                                                                                <apex:outputPanel layout="block" rendered="{!material4.existingComponents.size > 0}">
                                                                                    <apex:outputPanel layout="block" styleclass="nbcu_rw_table nbcu_table_existing_component">
                                                                                        <apex:variable value="{!0}" var="componentIndex4" />
                                                                                        <apex:pageBlockTable value="{!material4.existingComponents}" var="comp">
                                                                                            <apex:column headerValue="Material Description" styleClass="col_width_200">
                                                                                                <apex:outputField value="{!comp.instance.Name}" />
                                                                                                <apex:commandLink action="{!removeComponent}" rerender="MasterContainer, pgMsg" status="ajaxStatus" oncomplete="clickNbcuButtonSet();">
                                                                                                    <span style="padding-left:10px;"><apex:image id="RemoveImage" value="{!$Resource.Remove}" width="10" title="Remove"/></span>
                                                                                                    <apex:param value="{!comp.localComponentId}" name="componentIndex4" assignTo="{!componentIndex}" />
                                                                                                    <apex:param value="{!materialIndexPath4}" name="removeComponent4" assignTo="{!materialIndex}" />
                                                                                                    <apex:param value="{!4}" name="selectedMaterialLevel4" assignTo="{!selectedMaterialLevel}" />
                                                                                                </apex:commandLink>
                                                                                                <apex:variable var="componentIndex4" value="{!componentIndex4 + 1}" />
                                                                                            </apex:column>
                                                                                            
                                                                                            <apex:column headerValue="Component Number" styleClass="col_width_100">
                                                                                                <apex:outputField value="{!comp.instance.Material_Number__c}" />
                                                                                            </apex:column>
                                                                                            
                                                                                            <apex:column headerValue="Item Qty" styleClass="col_width_50">
                                                                                                <apex:inputText value="{!comp.ComponentQty}" styleClass="col_width_50"/>
                                                                                            </apex:column>
                                                                                            
                                                                                            <apex:column headerValue="Label Code" styleClass="col_width_100">
                                                                                                <apex:outputField value="{!comp.instance.Label_Code__c}" />
                                                                                            </apex:column>
                                                                                            <apex:column headerValue="Territory" styleClass="col_width_30">
                                                                                                <apex:outputField value="{!comp.instance.Territory__c}" />
                                                                                            </apex:column>
                                                                                        </apex:pageBlockTable>
                                                                                    </apex:outputPanel>
                                                                                </apex:outputPanel>
                                                                                
                                                                                <!-- New Components -->
                                                                                <apex:outputPanel layout="block" rendered="{!material4.newComponents.size > 0}">
                                                                                    <apex:outputPanel layout="block" styleclass="nbcu_rw_table">
                                                                                        <apex:variable value="{!0}" var="componentIndex4" />
                                                                                        <apex:pageBlockTable value="{!material4.newComponents}" var="comp">
                                                                                            <apex:column headerValue="Component Type">
                                                                                                <apex:inputField value="{!comp.instance.Component_Type__c}">
                                                                                                    <!-- added action support as part of REL-20 changes -->
                                                                                                    <apex:actionSupport event="onchange" reRender="MasterContainer" action="{!updateTerritoryOfDisc}" status="ajaxStatus" oncomplete="clickNbcuButtonSet();">
                                                                                                        <apex:param value="{!comp.localComponentId}" name="componentIndex4" assignTo="{!componentIndex}" />
                                                                                                        <!-- componentIndex1 -->
                                                                                                        <apex:param value="{!materialIndexPath4}" name="Component4" assignTo="{!materialIndex}" />
                                                                                                        <apex:param value="{!4}" name="selectedMaterialLevel4" assignTo="{!selectedMaterialLevel}" />
                                                                                                    </apex:actionSupport>
                                                                                                </apex:inputField>
                                                                                                <apex:commandLink action="{!removeComponent}" rerender="MasterContainer, pgMsg" status="ajaxStatus" oncomplete="clickNbcuButtonSet();">
                                                                                                    <span style="padding-left:10px;"><apex:image id="RemoveImage" value="{!$Resource.Remove}" width="10" title="Remove"/></span>
                                                                                                    <apex:param value="{!comp.localComponentId}" name="componentIndex4" assignTo="{!componentIndex}" />
                                                                                                    <!-- componentIndex1 -->
                                                                                                    <apex:param value="{!materialIndexPath4}" name="removeComponent4" assignTo="{!materialIndex}" />
                                                                                                    <apex:param value="{!4}" name="selectedMaterialLevel4" assignTo="{!selectedMaterialLevel}" />
                                                                                                </apex:commandLink>
                                                                                                <apex:variable var="componentIndex4" value="{!componentIndex4 + 1}" />
                                                                                            </apex:column>
                                                                                            
                                                                                            <apex:column headerValue="Item Qty">
                                                                                                <apex:inputText value="{!comp.ComponentQty}" styleClass="col_width_80"/>
                                                                                            </apex:column>
                                                                                            <apex:column headerValue="Territory">
                                                                                                <!--<apex:inputField value="{!comp.instance.Territory__c}" />-->
                                                                                                <apex:selectlist value="{!comp.instance.Territory__c}" size="1">
                                                                                                    <apex:selectoptions value="{!comp.lstTerritoryOptions}" />
                                                                                                </apex:selectList>
                                                                                            </apex:column>
                                                                                        </apex:pageBlockTable>
                                                                                    </apex:outputPanel>
                                                                                </apex:outputPanel>
                                                                                
                                                                            </apex:outputPanel>
                                                                            <!--level 4 nested panel ends here-->
                                                                            <apex:variable var="l4Index" value="{!(l4Index + 1)}" />
                                                                        </apex:outputPanel>
                                                                    </apex:repeat>
                                                                    <!--Pagination for level 4-->
                                                                    <apex:outputPanel layout="block" id="opBtn4" rendered="{!IF(material3.childIns.numberOfPages > 1, TRUE,FALSE)}" style="height:16px;background-color:#E09100;padding: 5px 10px 0px 10px;margin-top:2px;">
                                                                        <div style="color:white;float:left;width:45%;">
                                                                            <span><b>Page #: {!material3.childIns.currentPageNumber} of {!material3.childIns.numberOfPages} &nbsp; &nbsp;  Record Count: {!material3.childIns.numberOfRecords}</b></span>
                                                                        </div>            
                                                                        <div style="float:left;margin-top: -4px;">
                                                                            <apex:panelGrid columns="4" id="pnlGrid">
                                                                                <apex:commandLink action="{!material3.childIns.firstPage}" rendered="{!material3.childIns.DisablePrevious}" reRender="panel4thLevel, panel3rdLevel, panel2ndLevel, panel1stLevel" status="ajaxStatus" oncomplete="clickNbcuButtonSet();" style="color:white;font-weight:bold;">First</apex:commandlink>
                                                                                <apex:outputText value="First" rendered="{!NOT(material3.childIns.DisablePrevious)}" style="color:white"></apex:outputText>
                                                                                
                                                                                <apex:commandLink action="{!material3.childIns.previousPage}" rendered="{!material3.childIns.DisablePrevious}" reRender="panel4thLevel, panel3rdLevel, panel2ndLevel, panel1stLevel" status="ajaxStatus" oncomplete="clickNbcuButtonSet();" style="color:white;font-weight:bold;">Previous</apex:commandlink>
                                                                                <apex:outputText value="Previous" rendered="{!NOT(material3.childIns.DisablePrevious)}" style="color:white"></apex:outputText>
                                                                                
                                                                                <apex:commandLink action="{!material3.childIns.nextPage}" rendered="{!material3.childIns.DisableNext}" reRender="panel4thLevel, panel3rdLevel, panel2ndLevel, panel1stLevel" status="ajaxStatus" oncomplete="clickNbcuButtonSet();" style="color:white;font-weight:bold;">Next</apex:commandlink>
                                                                                <apex:outputText value="Next" rendered="{!NOT(material3.childIns.DisableNext)}" style="color:white"></apex:outputText>
                                                                                
                                                                                <apex:commandLink action="{!material3.childIns.lastPage}" rendered="{!material3.childIns.DisableNext}" reRender="panel4thLevel, panel3rdLevel, panel2ndLevel, panel1stLevel" status="ajaxStatus" oncomplete="clickNbcuButtonSet();" style="color:white;font-weight:bold;">Last</apex:commandlink>
                                                                                <apex:outputText value="Last" rendered="{!NOT(material3.childIns.DisableNext)}" style="color:white"></apex:outputText>
                                                                            </apex:panelGrid>            
                                                                        </div>
                                                                    </apex:outputPanel>                     
                                                                </apex:outputPanel>
                                                                <!--Pagination for level 4 ends-->
                                                                
                                                            </apex:outputPanel>
                                                            <!--level 3 nested panel ends-->
                                                            <apex:variable var="l3Index" value="{!(l3Index + 1)}" />
                                                        </apex:outputpanel>
                                                    </apex:repeat>
                                                    
                                                    <!--Pagination for level 3-->
                                                    <apex:outputPanel layout="block" id="opBtn3" rendered="{!IF(material2.childIns.numberOfPages > 1, TRUE,FALSE)}" style="height:16px;background-color:#7581BA;padding: 5px 10px 0px 10px;margin-top:2px;margin-bottom:10px;">
                                                        <div style="color:white;float:left;width:45%;">
                                                            <span ><b>Page #: {!material2.childIns.currentPageNumber} of {!material2.childIns.numberOfPages} &nbsp; &nbsp;  Record Count: {!material2.childIns.numberOfRecords}</b></span>
                                                        </div>            
                                                        <div style="float:left;margin-top: -4px;">
                                                            <apex:panelGrid columns="4" id="pnlGrid">                                                    
                                                                <apex:commandLink action="{!material2.childIns.firstPage}" rendered="{!material2.childIns.DisablePrevious}" reRender="panel3rdLevel, panel2ndLevel, panel1stLevel" status="ajaxStatus" oncomplete="clickNbcuButtonSet();" style="color:white;font-weight:bold;">First</apex:commandlink>
                                                                <apex:outputText value="First" rendered="{!NOT(material2.childIns.DisablePrevious)}" style="color:white"></apex:outputText>
                                                                
                                                                <apex:commandLink action="{!material2.childIns.previousPage}" rendered="{!material2.childIns.DisablePrevious}" reRender="panel3rdLevel, panel2ndLevel, panel1stLevel" status="ajaxStatus" oncomplete="clickNbcuButtonSet();" style="color:white;font-weight:bold;">Previous</apex:commandlink>
                                                                <apex:outputText value="Previous" rendered="{!NOT(material2.childIns.DisablePrevious)}" style="color:white"></apex:outputText>
                                                                
                                                                <apex:commandLink action="{!material2.childIns.nextPage}" rendered="{!material2.childIns.DisableNext}" reRender="panel3rdLevel, panel2ndLevel, panel1stLevel" status="ajaxStatus" oncomplete="clickNbcuButtonSet();" style="color:white;font-weight:bold;">Next</apex:commandlink>
                                                                <apex:outputText value="Next" rendered="{!NOT(material2.childIns.DisableNext)}" style="color:white"></apex:outputText>
                                                                
                                                                <apex:commandLink action="{!material2.childIns.lastPage}" rendered="{!material2.childIns.DisableNext}" reRender="panel3rdLevel, panel2ndLevel, panel1stLevel" status="ajaxStatus" oncomplete="clickNbcuButtonSet();" style="color:white;font-weight:bold;">Last</apex:commandlink>
                                                                <apex:outputText value="Last" rendered="{!NOT(material2.childIns.DisableNext)}" style="color:white"></apex:outputText>
                                                            </apex:panelGrid>            
                                                        </div>
                                                    </apex:outputPanel> 
                                                </apex:outputPanel>
                                                <!--Pagination for level 3 ends-->
                                                
                                            </apex:outputPanel>
                                            <!--level 2 nested panel ends-->
                                            <apex:variable var="l2Index" value="{!(l2Index + 1)}" />
                                        </apex:outputpanel>
                                    </apex:repeat>
                                    
                                    <!--Pagination for level 2-->
                                    <apex:outputPanel layout="block" id="opBtn2" rendered="{!IF(material.childIns.numberOfPages > 1, TRUE,FALSE)}" style="height:16px;background-color:#9BB063;padding: 5px 10px 0px 10px;margin-top:2px;">
                                        <div style="color:white;float:left;width:45%;">
                                            <span ><b>Page #: {!material.childIns.currentPageNumber} of {!material.childIns.numberOfPages} &nbsp; &nbsp;  Record Count: {!material.childIns.numberOfRecords}</b></span>
                                        </div>            
                                        <div style="float:left;margin-top: -4px;">
                                            <apex:panelGrid columns="4" id="pnlGrid">
                                                <apex:commandLink action="{!material.childIns.firstPage}" rendered="{!material.childIns.DisablePrevious}" reRender="panel2ndLevel, panel1stLevel" status="ajaxStatus" oncomplete="clickNbcuButtonSet();" style="color:white;font-weight:bold;">First</apex:commandlink>
                                                <apex:outputText value="First" rendered="{!NOT(material.childIns.DisablePrevious)}" style="color:white;"></apex:outputText>
                                                
                                                <apex:commandLink action="{!material.childIns.previousPage}" rendered="{!material.childIns.DisablePrevious}" reRender="panel2ndLevel, panel1stLevel" status="ajaxStatus" oncomplete="clickNbcuButtonSet();" style="color:white;font-weight:bold;">Previous</apex:commandlink>
                                                <apex:outputText value="Previous" rendered="{!NOT(material.childIns.DisablePrevious)}" style="color:white;"></apex:outputText>
                                                
                                                <apex:commandLink action="{!material.childIns.nextPage}" rendered="{!material.childIns.DisableNext}" reRender="panel2ndLevel, panel1stLevel" status="ajaxStatus" oncomplete="clickNbcuButtonSet();" style="color:white;font-weight:bold;">Next</apex:commandlink>
                                                <apex:outputText value="Next" rendered="{!NOT(material.childIns.DisableNext)}" style="color:white;"></apex:outputText>
                                                
                                                <apex:commandLink action="{!material.childIns.lastPage}" rendered="{!material.childIns.DisableNext}" reRender="panel2ndLevel, panel1stLevel" status="ajaxStatus" oncomplete="clickNbcuButtonSet();" style="color:white;font-weight:bold;">Last</apex:commandlink>
                                                <apex:outputText value="Last" rendered="{!NOT(material.childIns.DisableNext)}" style="color:white;"></apex:outputText>
                                            </apex:panelGrid>            
                                        </div>
                                    </apex:outputPanel> 
                                </apex:outputPanel>
                                <!--Pagination for level 2 ends-->                                
                            </apex:outputpanel>
                            <!--level 1 nested panel ends-->
                            <apex:variable var="l1Index" value="{!(l1Index + 1)}" />
                        </apex:outputPanel>
                        
                    </apex:repeat>
                    <!--Pagination for level 1-->
                    <apex:outputPanel layout="block" id="opBtn1" rendered="{!IF(rootIns.numberOfPages > 1, TRUE,FALSE)}" style="height:16px;background-color:#E38D84;padding: 5px 10px 0px 10px;margin-top:2px;">
                        <div style="color:white;float:left;width:45%;">
                            <span><b>Page #: {!rootIns.currentPageNumber} of {!rootIns.numberOfPages} &nbsp;&nbsp;  Record Count: {!rootIns.numberofRecords}</b></span>
                        </div>            
                        <div style="float:left;margin-top: -4px;">
                            <apex:panelGrid columns="4" id="pnlGrid">
                                <apex:commandLink action="{!rootIns.firstPage}" rendered="{!rootIns.DisablePrevious}" reRender="panel1stLevel" status="ajaxStatus" oncomplete="clickNbcuButtonSet();" style="color:white;font-weight:bold;">First</apex:commandlink>
                                <apex:outputText value="First" rendered="{!NOT(rootIns.DisablePrevious)}" style="color:white;"></apex:outputText>
                                
                                <apex:commandLink action="{!rootIns.previousPage}" rendered="{!rootIns.DisablePrevious}" reRender="panel1stLevel" status="ajaxStatus" oncomplete="clickNbcuButtonSet();" style="color:white;font-weight:bold;">Previous</apex:commandlink>
                                <apex:outputText value="Previous" rendered="{!NOT(rootIns.DisablePrevious)}" style="color:white;"></apex:outputText>
                                
                                <apex:commandLink action="{!rootIns.nextPage}" rendered="{!rootIns.DisableNext}" reRender="panel1stLevel" status="ajaxStatus" oncomplete="clickNbcuButtonSet();" style="color:white;font-weight:bold;">Next</apex:commandlink>
                                <apex:outputText value="Next" rendered="{!NOT(rootIns.DisableNext)}" style="color:white;"></apex:outputText>
                                
                                <apex:commandLink action="{!rootIns.lastPage}" rendered="{!rootIns.DisableNext}" reRender="panel1stLevel" status="ajaxStatus" oncomplete="clickNbcuButtonSet();" style="color:white;font-weight:bold;">Last</apex:commandlink>
                                <apex:outputText value="Last" rendered="{!NOT(rootIns.DisableNext)}" style="color:white;"></apex:outputText>
                            </apex:panelGrid>            
                        </div>
                    </apex:outputPanel>                    
                </apex:outputPanel>
                <!--Pagination for level 1 ends-->                
            </apex:pageBlock>
        </apex:outputPanel>
    </apex:form>    
</apex:page>